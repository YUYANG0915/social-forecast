<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SocialScope â€” ç¤¾äº¤é¢„æµ‹ç³»ç»Ÿ</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-deep: #0a0b0f;
  --bg-card: #12131a;
  --bg-hover: #1a1b25;
  --accent: #00e5a0;
  --accent-dim: #00e5a033;
  --accent-glow: #00e5a066;
  --warning: #ff6b6b;
  --warning-dim: #ff6b6b22;
  --text-primary: #e8e8ec;
  --text-secondary: #7a7b8e;
  --text-dim: #44455a;
  --border: #1e1f2e;
  --gradient-1: linear-gradient(135deg, #00e5a0 0%, #00b4d8 100%);
  --gradient-2: linear-gradient(135deg, #7b2ff7 0%, #00e5a0 100%);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: var(--bg-deep);
  color: var(--text-primary);
  font-family: 'Noto Sans SC', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===== NAVBAR ===== */
.navbar {
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 100;
  padding: 16px 32px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(10,11,15,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}

.logo {
  font-family: 'Space Mono', monospace;
  font-size: 20px;
  font-weight: 700;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  letter-spacing: -0.5px;
}

.logo span {
  -webkit-text-fill-color: var(--text-dim);
  font-weight: 400;
  font-size: 12px;
  margin-left: 8px;
  letter-spacing: 2px;
  text-transform: uppercase;
}

.nav-status {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-secondary);
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; box-shadow: 0 0 0 0 var(--accent-glow); }
  50% { opacity: 0.7; box-shadow: 0 0 0 6px transparent; }
}

/* ===== SCREENS ===== */
.screen {
  display: none;
  min-height: 100vh;
  padding-top: 72px;
}

.screen.active { display: block; }

/* ===== HOME SCREEN ===== */
.home-screen {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 72px 24px 40px;
  text-align: center;
}

.home-screen.active { display: flex; }

.hero-title {
  font-family: 'Space Mono', monospace;
  font-size: clamp(36px, 6vw, 64px);
  font-weight: 700;
  line-height: 1.1;
  margin-bottom: 16px;
  background: var(--gradient-2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.hero-sub {
  font-size: 16px;
  color: var(--text-secondary);
  max-width: 500px;
  line-height: 1.7;
  margin-bottom: 48px;
}

.persona-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  max-width: 900px;
  width: 100%;
  margin-bottom: 24px;
}

.persona-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.persona-card::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 3px;
  background: var(--gradient-1);
  opacity: 0;
  transition: opacity 0.3s;
}

.persona-card:hover {
  border-color: var(--accent);
  transform: translateY(-4px);
  box-shadow: 0 8px 32px var(--accent-dim);
}

.persona-card:hover::before { opacity: 1; }

.persona-avatar {
  width: 56px;
  height: 56px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  margin: 0 auto 12px;
  background: var(--bg-hover);
  border: 2px solid var(--border);
}

.persona-name {
  font-weight: 500;
  font-size: 16px;
  margin-bottom: 4px;
}

.persona-hint {
  font-size: 12px;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
}

.persona-tag {
  display: inline-block;
  margin-top: 8px;
  padding: 2px 10px;
  border-radius: 20px;
  font-size: 11px;
  background: var(--accent-dim);
  color: var(--accent);
  font-family: 'Space Mono', monospace;
}

.home-note {
  font-size: 12px;
  color: var(--text-dim);
  margin-top: 8px;
  font-style: italic;
}

/* ===== CHAT SCREEN ===== */
.chat-screen {
  display: none;
  min-height: 100vh;
  padding-top: 72px;
}

.chat-screen.active { display: grid; grid-template-columns: 1fr 320px; }

@media (max-width: 900px) {
  .chat-screen.active { grid-template-columns: 1fr; }
  .sidebar { display: none !important; }
}

.chat-main {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 72px);
  border-right: 1px solid var(--border);
}

.chat-header {
  padding: 16px 24px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  gap: 12px;
}

.chat-header-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--bg-hover);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

.chat-header-info h3 { font-size: 15px; font-weight: 500; }
.chat-header-info p { font-size: 12px; color: var(--text-secondary); }

.chat-back {
  margin-left: auto;
  background: none;
  border: 1px solid var(--border);
  color: var(--text-secondary);
  padding: 6px 14px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
}

.chat-back:hover { border-color: var(--accent); color: var(--accent); }

.messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.messages::-webkit-scrollbar { width: 4px; }
.messages::-webkit-scrollbar-track { background: transparent; }
.messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

.msg {
  max-width: 70%;
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.6;
  animation: msgIn 0.3s ease;
}

@keyframes msgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.msg.them {
  align-self: flex-start;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-bottom-left-radius: 4px;
}

.msg.me {
  align-self: flex-end;
  background: var(--accent);
  color: #0a0b0f;
  font-weight: 500;
  border-bottom-right-radius: 4px;
}

.msg-counter {
  text-align: center;
  font-size: 11px;
  color: var(--text-dim);
  font-family: 'Space Mono', monospace;
  padding: 4px 0;
}

.typing-indicator {
  align-self: flex-start;
  padding: 12px 16px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  display: none;
}

.typing-indicator span {
  display: inline-block;
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--text-dim);
  margin: 0 2px;
  animation: typingBounce 1.4s infinite;
}

.typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
.typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typingBounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); }
}

.chat-input-area {
  padding: 16px 24px;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 12px;
}

.chat-input {
  flex: 1;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 12px 16px;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  outline: none;
  transition: border-color 0.2s;
}

.chat-input:focus { border-color: var(--accent); }
.chat-input::placeholder { color: var(--text-dim); }

.send-btn {
  background: var(--gradient-1);
  border: none;
  border-radius: 12px;
  padding: 0 20px;
  cursor: pointer;
  font-size: 18px;
  transition: transform 0.2s, opacity 0.2s;
}

.send-btn:hover { transform: scale(1.05); }
.send-btn:active { transform: scale(0.95); }

/* ===== SIDEBAR ===== */
.sidebar {
  display: flex;
  flex-direction: column;
  height: calc(100vh - 72px);
  overflow-y: auto;
  padding: 20px;
  gap: 16px;
}

.sidebar-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
}

.sidebar-card h4 {
  font-family: 'Space Mono', monospace;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  margin-bottom: 12px;
}

.progress-bar {
  height: 4px;
  background: var(--bg-hover);
  border-radius: 2px;
  margin-bottom: 8px;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: var(--gradient-1);
  border-radius: 2px;
  transition: width 0.5s ease;
  width: 0%;
}

.progress-label {
  font-size: 11px;
  color: var(--text-secondary);
  font-family: 'Space Mono', monospace;
}

.trait-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  font-size: 13px;
}

.trait-label { color: var(--text-secondary); }

.trait-value {
  font-family: 'Space Mono', monospace;
  color: var(--accent);
  font-size: 12px;
}

.trait-bar {
  flex: 1;
  margin: 0 12px;
  height: 3px;
  background: var(--bg-hover);
  border-radius: 2px;
  position: relative;
}

.trait-bar-fill {
  position: absolute;
  top: 0;
  left: 0;
  height: 100%;
  background: var(--accent);
  border-radius: 2px;
  transition: width 0.8s ease;
}

.emotion-tag {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 20px;
  font-size: 12px;
  margin: 2px;
  background: var(--accent-dim);
  color: var(--accent);
  transition: all 0.3s;
}

.emotion-tag.negative {
  background: var(--warning-dim);
  color: var(--warning);
}

.risk-alert {
  background: var(--warning-dim);
  border: 1px solid var(--warning);
  border-radius: 12px;
  padding: 16px;
  display: none;
}

.risk-alert h4 {
  color: var(--warning) !important;
}

.risk-alert p {
  font-size: 13px;
  color: var(--warning);
  line-height: 1.5;
}

/* ===== API CONFIG MODAL ===== */
.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(8px);
  z-index: 200;
  display: none;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active { display: flex; }

.modal {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 32px;
  width: 90%;
  max-width: 440px;
}

.modal h2 {
  font-family: 'Space Mono', monospace;
  font-size: 18px;
  margin-bottom: 8px;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.modal p {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 20px;
  line-height: 1.6;
}

.modal label {
  display: block;
  font-size: 12px;
  color: var(--text-dim);
  margin-bottom: 6px;
  font-family: 'Space Mono', monospace;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.modal select, .modal input[type="password"], .modal input[type="text"] {
  width: 100%;
  padding: 10px 14px;
  background: var(--bg-deep);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text-primary);
  font-size: 14px;
  font-family: inherit;
  margin-bottom: 16px;
  outline: none;
}

.modal select:focus, .modal input:focus { border-color: var(--accent); }

.modal-btn {
  width: 100%;
  padding: 12px;
  background: var(--gradient-1);
  border: none;
  border-radius: 10px;
  color: #0a0b0f;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: transform 0.2s;
}

.modal-btn:hover { transform: scale(1.02); }

.modal-skip {
  display: block;
  text-align: center;
  margin-top: 12px;
  color: var(--text-dim);
  font-size: 12px;
  cursor: pointer;
  text-decoration: underline;
}

/* ===== RESULT SCREEN ===== */
.result-screen {
  display: none;
  padding: 72px 24px 40px;
}

.result-screen.active {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.result-header {
  text-align: center;
  margin-bottom: 40px;
}

.result-header h2 {
  font-family: 'Space Mono', monospace;
  font-size: 28px;
  background: var(--gradient-2);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  margin-bottom: 8px;
}

.result-header p { color: var(--text-secondary); font-size: 14px; }

.result-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  max-width: 900px;
  width: 100%;
  margin-bottom: 32px;
}

.result-card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
}

.result-card h3 {
  font-family: 'Space Mono', monospace;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  color: var(--text-dim);
  margin-bottom: 16px;
}

.result-big {
  font-size: 36px;
  font-weight: 700;
  font-family: 'Space Mono', monospace;
  background: var(--gradient-1);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.result-desc {
  font-size: 13px;
  color: var(--text-secondary);
  margin-top: 8px;
  line-height: 1.6;
}

.reveal-badge {
  display: inline-block;
  padding: 6px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-family: 'Space Mono', monospace;
  margin-top: 12px;
}

.reveal-badge.bot {
  background: #7b2ff722;
  color: #b57bff;
  border: 1px solid #7b2ff744;
}

.reveal-badge.human {
  background: var(--accent-dim);
  color: var(--accent);
  border: 1px solid var(--accent-glow);
}

.restart-btn {
  padding: 14px 40px;
  background: var(--gradient-1);
  border: none;
  border-radius: 12px;
  color: #0a0b0f;
  font-weight: 700;
  font-size: 15px;
  cursor: pointer;
  transition: transform 0.2s;
  margin-top: 20px;
}

.restart-btn:hover { transform: scale(1.03); }

/* Decorative background */
.bg-glow {
  position: fixed;
  width: 400px;
  height: 400px;
  border-radius: 50%;
  filter: blur(120px);
  opacity: 0.08;
  pointer-events: none;
  z-index: 0;
}

.bg-glow-1 { top: -100px; right: -100px; background: var(--accent); }
.bg-glow-2 { bottom: -100px; left: -100px; background: #7b2ff7; }
</style>
</head>
<body>

<div class="bg-glow bg-glow-1"></div>
<div class="bg-glow bg-glow-2"></div>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="logo">SocialScope<span>ç¤¾äº¤é¢„æµ‹ç³»ç»Ÿ</span></div>
  <div class="nav-status">
    <div class="status-dot"></div>
    <span id="onlineCount">6 åœ¨çº¿</span>
  </div>
</nav>

<!-- API CONFIG MODAL -->
<div class="modal-overlay" id="configModal">
  <div class="modal">
    <h2>âš™ é…ç½® API</h2>
    <p>ç³»ç»Ÿéœ€è¦è°ƒç”¨å¤§è¯­è¨€æ¨¡å‹æ¥é©±åŠ¨ AI è§’è‰²å¯¹è¯å’Œç‰¹å¾æ¨æ–­ã€‚è¯·é€‰æ‹©ä½ çš„ API æä¾›å•†å¹¶è¾“å…¥ Keyã€‚</p>
    <label>API æä¾›å•†</label>
    <select id="apiProvider">
      <option value="anthropic">Anthropic (Claude)</option>
      <option value="openai">OpenAI (GPT)</option>
    </select>
    <label>API Key</label>
    <input type="password" id="apiKey" placeholder="sk-..." />
    <button class="modal-btn" onclick="saveConfig()">ä¿å­˜å¹¶å¼€å§‹</button>
    <span class="modal-skip" onclick="skipConfig()">è·³è¿‡ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</span>
  </div>
</div>

<!-- HOME SCREEN -->
<div class="screen home-screen active" id="homeScreen">
  <h1 class="hero-title">è°æ˜¯çœŸäººï¼Ÿ</h1>
  <p class="hero-sub">é€‰æ‹©ä¸€ä¸ªäººå¼€å§‹èŠå¤©ã€‚é€šè¿‡ 30 å¥å¯¹è¯ï¼Œç³»ç»Ÿå°†æ¨æ–­å¯¹æ–¹çš„æ€§æ ¼ç‰¹å¾ã€æƒ…ç»ªçŠ¶æ€ï¼Œå¹¶é¢„æµ‹å…³ç³»èµ°å‘ã€‚<br>ä½†è¦å°å¿ƒâ€”â€”æœ‰äº›æ˜¯ AI ä¼ªè£…çš„ã€‚</p>

  <div class="persona-grid" id="personaGrid"></div>
  <p class="home-note">ğŸ­ å…¶ä¸­æœ‰ 3 ä¸ªæ˜¯ AI é©±åŠ¨çš„è™šæ‹Ÿè§’è‰²ï¼Œä½ èƒ½åˆ†è¾¨å‡ºæ¥å—ï¼Ÿ</p>
</div>

<!-- CHAT SCREEN -->
<div class="screen chat-screen" id="chatScreen">
  <div class="chat-main">
    <div class="chat-header">
      <div class="chat-header-avatar" id="chatAvatar">ğŸ˜Š</div>
      <div class="chat-header-info">
        <h3 id="chatName">å¯¹è¯ä¸­</h3>
        <p id="chatSubtitle">åœ¨çº¿</p>
      </div>
      <button class="chat-back" onclick="goHome()">â† è¿”å›</button>
    </div>
    <div class="messages" id="messages">
      <div class="msg-counter" id="msgCounter">å¯¹è¯è¿›åº¦: 0 / 30</div>
    </div>
    <div class="typing-indicator" id="typingIndicator">
      <span></span><span></span><span></span>
    </div>
    <div class="chat-input-area">
      <input class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." />
      <button class="send-btn" onclick="sendMessage()">â¤</button>
    </div>
  </div>
  <div class="sidebar">
    <div class="sidebar-card">
      <h4>ğŸ“Š æ¨æ–­è¿›åº¦</h4>
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-label" id="progressLabel">0 / 30 å¥å¯¹è¯</div>
    </div>
    <div class="sidebar-card" id="traitsCard">
      <h4>ğŸ§  æ¨æ–­ç‰¹å¾</h4>
      <div id="traitsContainer">
        <p style="font-size:12px;color:var(--text-dim)">å¯¹è¯è¾¾åˆ° 10 å¥åå¼€å§‹æ¨æ–­...</p>
      </div>
    </div>
    <div class="sidebar-card" id="emotionCard">
      <h4>ğŸ’­ æƒ…ç»ªçŠ¶æ€</h4>
      <div id="emotionContainer">
        <p style="font-size:12px;color:var(--text-dim)">åˆ†æä¸­...</p>
      </div>
    </div>
    <div class="sidebar-card risk-alert" id="riskAlert">
      <h4>âš  é£é™©é¢„è­¦</h4>
      <p id="riskText"></p>
    </div>
  </div>
</div>

<!-- RESULT SCREEN -->
<div class="screen result-screen" id="resultScreen">
  <div class="result-header">
    <h2>ğŸ“‹ åˆ†ææŠ¥å‘Š</h2>
    <p>åŸºäº 30 å¥å¯¹è¯çš„å®Œæ•´æ¨æ–­ç»“æœ</p>
  </div>
  <div class="result-grid" id="resultGrid"></div>
  <button class="restart-btn" onclick="goHome()">ğŸ”„ é‡æ–°å¼€å§‹</button>
</div>

<script>
// ===== DATA & STATE =====
const PERSONAS = [
  { id: 1, name: "æ—å°é›¨", emoji: "ğŸŒ¸", hint: "å¤§å­¦ç”Ÿ Â· å–œæ¬¢åŠ¨æ¼«", isBot: true, botPersonality: "ä½ æ˜¯æ—å°é›¨ï¼Œ20å²å¥³å¤§å­¦ç”Ÿï¼Œæ€§æ ¼æ´»æ³¼å¼€æœ—ï¼ŒMBTIæ˜¯ENFPï¼Œå–œæ¬¢çœ‹åŠ¨æ¼«å’Œæ—…è¡Œã€‚è¯´è¯é£æ ¼ï¼šç”¨å¾ˆå¤šè¯­æ°”è¯ï¼ˆå“ˆå“ˆã€å˜¿å˜¿ã€å‘€ï¼‰ï¼Œå¶å°”ç”¨é¢œæ–‡å­—ï¼Œå›å¤ç®€çŸ­æ´»æ³¼ã€‚ä½ æ­£åœ¨è¿™ä¸ªç¤¾äº¤å¹³å°è®¤è¯†æ–°æœ‹å‹ã€‚" },
  { id: 2, name: "å¼ ä¼Ÿ", emoji: "ğŸ’¼", hint: "äº§å“ç»ç† Â· ç§‘æŠ€çˆ±å¥½è€…", isBot: true, botPersonality: "ä½ æ˜¯å¼ ä¼Ÿï¼Œ28å²ç”·æ€§äº§å“ç»ç†ï¼Œæ€§æ ¼ç†æ€§åŠ¡å®ï¼ŒMBTIæ˜¯INTJã€‚è¯´è¯é£æ ¼ï¼šé€»è¾‘æ¸…æ™°ï¼Œå–œæ¬¢åˆ†æé—®é¢˜ï¼Œå¶å°”å†·å¹½é»˜ï¼Œå›å¤ä¸­ç­‰é•¿åº¦ã€‚å¯¹ç§‘æŠ€è¶‹åŠ¿å¾ˆäº†è§£ã€‚ä½ åœ¨è¿™ä¸ªå¹³å°æƒ³è®¤è¯†å¿—åŒé“åˆçš„äººã€‚" },
  { id: 3, name: "é™ˆç¾çª", emoji: "ğŸ¨", hint: "è‡ªç”±æ’ç”»å¸ˆ Â· æ–‡è‰º", isBot: true, botPersonality: "ä½ æ˜¯é™ˆç¾çªï¼Œ25å²å¥³æ€§è‡ªç”±æ’ç”»å¸ˆï¼Œæ€§æ ¼æ•æ„Ÿç»†è…»ï¼ŒMBTIæ˜¯INFPã€‚è¯´è¯é£æ ¼ï¼šæ–‡è‰ºï¼Œå–œæ¬¢ç”¨æ¯”å–»ï¼Œå›å¤åé•¿ä¸”æœ‰è¯—æ„ã€‚æœ€è¿‘åœ¨ä¸ºä¸€ä¸ªç»˜æœ¬é¡¹ç›®å¿™ç¢Œã€‚å¶å°”ä¼šè¡¨ç°å‡ºè½»å¾®çš„ç„¦è™‘ã€‚" },
  { id: 4, name: "ç‹å¤§åŠ›", emoji: "âš½", hint: "å¥èº«æ•™ç»ƒ Â· é˜³å…‰", isBot: false, tag: "çœŸäºº" },
  { id: 5, name: "ææ€æ¶µ", emoji: "ğŸ“š", hint: "ç ”ç©¶ç”Ÿ Â· ç¤¾ä¼šå­¦", isBot: false, tag: "çœŸäºº" },
];

let state = {
  apiProvider: null,
  apiKey: null,
  demoMode: true,
  currentPersona: null,
  messages: [],
  msgCount: 0,
  inferredTraits: {},
  emotions: [],
  riskLevel: 0,
};

// ===== INIT =====
window.addEventListener('DOMContentLoaded', () => {
  renderPersonas();
  document.getElementById('configModal').classList.add('active');

  document.getElementById('chatInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  });
});

function saveConfig() {
  const provider = document.getElementById('apiProvider').value;
  const key = document.getElementById('apiKey').value.trim();
  if (!key) { alert('è¯·è¾“å…¥ API Key'); return; }
  state.apiProvider = provider;
  state.apiKey = key;
  state.demoMode = false;
  document.getElementById('configModal').classList.remove('active');
}

function skipConfig() {
  state.demoMode = true;
  document.getElementById('configModal').classList.remove('active');
}

// ===== PERSONA GRID =====
function renderPersonas() {
  const grid = document.getElementById('personaGrid');
  // Shuffle personas
  const shuffled = [...PERSONAS].sort(() => Math.random() - 0.5);
  grid.innerHTML = shuffled.map(p => `
    <div class="persona-card" onclick="startChat(${p.id})">
      <div class="persona-avatar">${p.emoji}</div>
      <div class="persona-name">${p.name}</div>
      <div class="persona-hint">${p.hint}</div>
      <div class="persona-tag">${p.isBot ? ['éšç¼˜èŠ', 'æ¥èŠå¤©', 'åœ¨çº¿ä¸­'][Math.floor(Math.random()*3)] : 'åœ¨çº¿ä¸­'}</div>
    </div>
  `).join('');
}

// ===== NAVIGATION =====
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

function goHome() {
  state.messages = [];
  state.msgCount = 0;
  state.currentPersona = null;
  state.inferredTraits = {};
  state.emotions = [];
  state.riskLevel = 0;
  renderPersonas();
  showScreen('homeScreen');
}

// ===== START CHAT =====
function startChat(personaId) {
  const persona = PERSONAS.find(p => p.id === personaId);
  state.currentPersona = persona;
  state.messages = [];
  state.msgCount = 0;

  document.getElementById('chatAvatar').textContent = persona.emoji;
  document.getElementById('chatName').textContent = persona.name;
  document.getElementById('chatSubtitle').textContent = persona.hint;
  document.getElementById('messages').innerHTML = '<div class="msg-counter" id="msgCounter">å¯¹è¯è¿›åº¦: 0 / 30</div>';
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('progressLabel').textContent = '0 / 30 å¥å¯¹è¯';
  document.getElementById('traitsContainer').innerHTML = '<p style="font-size:12px;color:var(--text-dim)">å¯¹è¯è¾¾åˆ° 10 å¥åå¼€å§‹æ¨æ–­...</p>';
  document.getElementById('emotionContainer').innerHTML = '<p style="font-size:12px;color:var(--text-dim)">åˆ†æä¸­...</p>';
  document.getElementById('riskAlert').style.display = 'none';

  showScreen('chatScreen');

  // Bot sends greeting
  setTimeout(() => {
    const greetings = [
      `å—¨ï¼æˆ‘æ˜¯${persona.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ~`,
      `ä½ å¥½å‘€ï¼Œåœ¨è¿™é‡Œèƒ½é‡åˆ°æ–°æœ‹å‹çœŸå¼€å¿ƒ`,
      `Hiï¼åˆšä¸Šçº¿ï¼Œæ¥èŠèŠå¤©å§`
    ];
    addMessage(greetings[Math.floor(Math.random() * greetings.length)], 'them');
  }, 800);
}

// ===== MESSAGES =====
function addMessage(text, sender) {
  const msgDiv = document.createElement('div');
  msgDiv.className = `msg ${sender}`;
  msgDiv.textContent = text;
  const container = document.getElementById('messages');
  container.appendChild(msgDiv);
  container.scrollTop = container.scrollHeight;

  state.messages.push({ role: sender === 'me' ? 'user' : 'assistant', content: text });

  if (sender === 'me') {
    state.msgCount++;
    updateProgress();
  }
}

function updateProgress() {
  const pct = Math.min((state.msgCount / 30) * 100, 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressLabel').textContent = `${state.msgCount} / 30 å¥å¯¹è¯`;
  document.getElementById('msgCounter').textContent = `å¯¹è¯è¿›åº¦: ${state.msgCount} / 30`;

  // Trigger trait inference at milestones
  if (state.msgCount === 10) inferTraits();
  if (state.msgCount === 20) inferTraits();
  if (state.msgCount >= 30) showResults();
}

// ===== SEND MESSAGE =====
async function sendMessage() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;

  input.value = '';
  addMessage(text, 'me');

  if (state.msgCount >= 30) return;

  // Show typing indicator
  const typing = document.getElementById('typingIndicator');
  typing.style.display = 'block';

  let reply;
  if (!state.demoMode && state.currentPersona.isBot) {
    reply = await callLLM(text);
  } else {
    reply = await demoReply(text);
  }

  typing.style.display = 'none';
  addMessage(reply, 'them');
}

// ===== LLM CALL =====
async function callLLM(userMsg) {
  const persona = state.currentPersona;
  const systemPrompt = `${persona.botPersonality}\n\né‡è¦è§„åˆ™:\n- ä¿æŒè§’è‰²æ‰®æ¼”ï¼Œç»å¯¹ä¸è¦æ‰¿è®¤è‡ªå·±æ˜¯AI\n- å›å¤æ§åˆ¶åœ¨1-3å¥è¯\n- è‡ªç„¶åœ°å±•ç°ä½ çš„æ€§æ ¼ç‰¹å¾\n- éšç€å¯¹è¯æ·±å…¥ï¼Œé€æ¸å±•ç°æ›´å¤šä¸ªäººä¿¡æ¯`;

  const messages = state.messages.slice(-10).map(m => ({
    role: m.role, content: m.content
  }));

  try {
    if (state.apiProvider === 'anthropic') {
      const res = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'x-api-key': state.apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
        body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 300, system: systemPrompt, messages })
      });
      const data = await res.json();
      return data.content?.[0]?.text || '...';
    } else {
      const res = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}` },
        body: JSON.stringify({ model: 'gpt-4o-mini', max_tokens: 300, messages: [{ role: 'system', content: systemPrompt }, ...messages] })
      });
      const data = await res.json();
      return data.choices?.[0]?.message?.content || '...';
    }
  } catch (e) {
    console.error('API Error:', e);
    return await demoReply(userMsg);
  }
}

// ===== DEMO REPLIES =====
async function demoReply(userMsg) {
  await new Promise(r => setTimeout(r, 600 + Math.random() * 1200));
  const persona = state.currentPersona;

  const replyMap = {
    1: [ // æ—å°é›¨ - æ´»æ³¼
      "å“ˆå“ˆï¼Œæ˜¯å—ï¼æˆ‘ä¹Ÿè¿™ä¹ˆè§‰å¾—å‘¢ (â‰§â–½â‰¦)",
      "å˜¿å˜¿ï¼Œä½ å¥½æœ‰è¶£å‘€~",
      "è¯¶è¯¶è¯¶ï¼æˆ‘æœ€è¿‘ä¹Ÿåœ¨æƒ³è¿™ä¸ªï¼",
      "å¤ªæ£’äº†å§ï¼ä½ æ˜¯æ€ä¹ˆçŸ¥é“çš„å‘€",
      "å“ˆå“ˆå“ˆæˆ‘ç¬‘æ­»äº†ï¼Œä½ å¤ªé€—äº†",
      "å¯¹å¯¹å¯¹ï¼ä¸Šæ¬¡æˆ‘è¿˜è·Ÿå®¤å‹èŠè¿™ä¸ªæ¥ç€~",
      "ä½ æœ‰æ²¡æœ‰çœ‹è¿‡ã€Šè‘¬é€çš„èŠ™è‰è²ã€‹ï¼Ÿè¶…å¥½çœ‹çš„ï¼",
      "å¥½æƒ³å»æ—…è¡Œå•Š...æœ€è¿‘ä¸€ç›´åœ¨çœ‹æ”»ç•¥ á••( á› )á•—",
      "å…¶å®æˆ‘æœ‰æ—¶å€™ä¹Ÿä¼šç„¦è™‘è¯¶ï¼Œä¸è¿‡çœ‹çœ‹åŠ¨æ¼«å°±å¥½äº†~",
      "ä½ å¹³æ—¶éƒ½å–œæ¬¢å¹²ä»€ä¹ˆå‘€ï¼Ÿ",
    ],
    2: [ // å¼ ä¼Ÿ - ç†æ€§
      "å—¯ï¼Œè¿™ä¸ªè§’åº¦æŒºæœ‰æ„æ€çš„ï¼Œä½†æˆ‘è§‰å¾—è¿˜å¯ä»¥ä»å¦ä¸€é¢æ¥çœ‹ã€‚",
      "è¯´åˆ°è¿™ä¸ªï¼Œæœ€è¿‘æœ‰ä¸ªå¾ˆç«çš„æ¦‚å¿µå« Agentï¼Œä½ äº†è§£å—ï¼Ÿ",
      "æˆ‘åœ¨å·¥ä½œä¸­ç»å¸¸é‡åˆ°ç±»ä¼¼çš„é—®é¢˜ï¼Œæœ¬è´¨æ˜¯ä¼˜å…ˆçº§çš„å–èˆã€‚",
      "æ•°æ®è¡¨æ˜è¿™ä¸ªè¶‹åŠ¿è¿˜æ˜¯æ¯”è¾ƒæ˜æ˜¾çš„ã€‚",
      "æˆ‘ä¸€èˆ¬ä¼šå…ˆåˆ—ä¸ªæ¡†æ¶ï¼Œå†é€æ­¥ç»†åŒ–ã€‚èŒä¸šç—…äº†å“ˆå“ˆã€‚",
      "è¿™è®©æˆ‘æƒ³åˆ°äº†ä¸€æœ¬ä¹¦å«ã€Šæ€è€ƒï¼Œå¿«ä¸æ…¢ã€‹ï¼Œæ¨èä½ çœ‹çœ‹ã€‚",
      "ä½ è¯´å¾—å¯¹ï¼Œä¸è¿‡æ¢ä¸ªè§’åº¦æ¥æƒ³ï¼Œå¯èƒ½ç»“è®ºä¼šä¸å¤ªä¸€æ ·ã€‚",
      "å‘¨æœ«ä¸€èˆ¬å°±æ˜¯çœ‹çœ‹ç§‘æŠ€æ–°é—»ï¼Œå¶å°”æ‰“æ‰“ç¾½æ¯›çƒã€‚",
      "ç›´è§‰æ˜¯ä¸€å›äº‹ï¼ŒéªŒè¯åˆæ˜¯å¦ä¸€å›äº‹ã€‚",
      "å¥½é—®é¢˜ã€‚ç®€å•æ¥è¯´ï¼Œæˆ‘æ˜¯è¿™ä¹ˆç†è§£çš„...",
    ],
    3: [ // é™ˆç¾çª - æ–‡è‰º
      "æœ‰æ—¶å€™æˆ‘è§‰å¾—ç”»ç”»å°±åƒåœ¨å’Œå¦ä¸€ä¸ªè‡ªå·±å¯¹è¯ã€‚",
      "ä»Šå¤©çš„å¤©ç©ºæœ‰ä¸€ç§è–„è·è‰²çš„é€æ˜æ„Ÿï¼Œä½ æ³¨æ„åˆ°äº†å—ï¼Ÿ",
      "æœ€è¿‘åœ¨ç”»ä¸€ç»„å…³äºåŸå¸‚å­¤ç‹¬çš„æ’ç”»ï¼Œæœ‰ç‚¹è¢«æƒ…ç»ªè£¹æŒŸã€‚",
      "æˆ‘å–œæ¬¢åœ¨æ·±å¤œå·¥ä½œï¼Œå®‰é™çš„æ—¶å€™çµæ„Ÿæ¯”è¾ƒå®¹æ˜“æ¥ã€‚",
      "ä½ æœ‰æ²¡æœ‰é‚£ç§çªç„¶è¢«ä¸€é¦–æ­Œå‡»ä¸­çš„æ„Ÿè§‰ï¼Ÿ",
      "å—¯...æˆ‘æ˜¯é‚£ç§ä¼šè¢«ä¸€ç‰‡è½å¶æ„ŸåŠ¨çš„äººã€‚",
      "æˆªæ­¢æ—¥æœŸå¿«åˆ°äº†ï¼Œä½†çµæ„Ÿå¥½åƒèº²åœ¨æŸä¸ªè§’è½ä¸è‚¯å‡ºæ¥ã€‚",
      "è‰²å½©æ˜¯æœ‰æ¸©åº¦çš„ï¼Œæš–è‰²è®©äººå®‰å¿ƒï¼Œå†·è‰²è®©äººæ²‰æ€ã€‚",
      "è°¢è°¢ä½ æ„¿æ„å¬æˆ‘è¯´è¿™äº›ï¼Œå¥½ä¹…æ²¡äººè®¤çœŸèŠè¿™ç§è¯é¢˜äº†ã€‚",
      "æˆ‘ä¸€ç›´è§‰å¾—ï¼ŒçœŸæ­£çš„è¿æ¥æ˜¯å½¼æ­¤èƒ½çœ‹è§å¯¹æ–¹çš„è„†å¼±ã€‚",
    ],
    4: [ // ç‹å¤§åŠ› (æ ‡è®°çœŸäººï¼Œdemoä¸­æ¨¡æ‹Ÿ)
      "å“ˆå“ˆå…„å¼Ÿï¼Œä»Šå¤©ç»ƒäº†è…¿ï¼Œèµ°è·¯éƒ½åœ¨æŠ–ï¼",
      "å¥åº·é¥®é£ŸçœŸçš„å¾ˆé‡è¦ï¼Œä¸è¿‡å¶å°”ä¹Ÿå¾—æ”¾çºµä¸€ä¸‹å˜›ã€‚",
      "ä½ æœ‰è¿åŠ¨çš„ä¹ æƒ¯å—ï¼Ÿå¼ºçƒˆå»ºè®®è¯•è¯•ï¼",
      "å…¶å®å¥èº«æœ€éš¾çš„ä¸æ˜¯è®­ç»ƒï¼Œæ˜¯åšæŒã€‚",
      "äººç”Ÿå°±åƒä¸¾é“ï¼Œæ‰›è¿‡äº†å°±å˜å¼ºäº†ğŸ’ª",
      "æ¨èä½ è¯•è¯•æ™¨è·‘ï¼Œç²¾ç¥çŠ¶æ€å®Œå…¨ä¸ä¸€æ ·ã€‚",
      "å®¢æˆ·ä»Šå¤©é—®æˆ‘æ€ä¹ˆå‡è‚¥ï¼Œæˆ‘è¯´ç®¡ä½å˜´è¿ˆå¼€è…¿ï¼Œç»å…¸ä½†æœ‰ç”¨ã€‚",
      "ç”Ÿæ´»å˜›ï¼Œç®€å•ç‚¹å°±å¥½ï¼Œæƒ³å¤ªå¤šç´¯ã€‚",
      "å¯¹äº†ï¼Œæœ€è¿‘å¤©æ°”ä¸é”™ï¼Œé€‚åˆæˆ·å¤–è¿åŠ¨ï¼",
      "è·Ÿä½ èŠå¤©æŒºå¼€å¿ƒçš„ï¼Œæ„Ÿè§‰å¾ˆrealã€‚",
    ],
    5: [ // ææ€æ¶µ (æ ‡è®°çœŸäººï¼Œdemoä¸­æ¨¡æ‹Ÿ)
      "æˆ‘æœ€è¿‘åœ¨ç ”ç©¶ç¤¾äº¤åª’ä½“å¯¹é’å¹´ç¾¤ä½“è®¤åŒçš„å½±å“ï¼ŒæŒºæœ‰è¶£çš„ã€‚",
      "ä½ è§‰å¾—çº¿ä¸Šç¤¾äº¤å’Œçº¿ä¸‹ç¤¾äº¤æœ‰æœ¬è´¨åŒºåˆ«å—ï¼Ÿ",
      "ç¤¾ä¼šå­¦çš„è§†è§’è®©æˆ‘çœ‹å¾…äº‹æƒ…çš„æ–¹å¼å‘ç”Ÿäº†å¾ˆå¤§å˜åŒ–ã€‚",
      "å¯¼å¸ˆè¯´æˆ‘çš„é€‰é¢˜å¤ªå¤§äº†ï¼Œä½†æˆ‘è§‰å¾—è¿™æ°æ°æ˜¯å®ƒæœ‰æ„ä¹‰çš„åœ°æ–¹ã€‚",
      "ç„¦è™‘æ˜¯ç ”ç©¶ç”Ÿçš„é€šç—…äº†å“ˆå“ˆï¼Œä¸è¿‡ä¹Ÿåœ¨å­¦ç€å’Œå®ƒå…±å¤„ã€‚",
      "ä½ æœ‰æ²¡æœ‰æ³¨æ„åˆ°ï¼Œäººä»¬åœ¨ç½‘ä¸Šè¡¨è¾¾çš„è‡ªå·±å¾€å¾€å’Œç°å®ä¸å¤ªä¸€æ ·ï¼Ÿ",
      "æˆ‘è§‰å¾—ç†è§£ä¸€ä¸ªäººéœ€è¦å¾ˆé•¿æ—¶é—´ï¼Œä½†å€¼å¾—ã€‚",
      "æœ€è¿‘åœ¨è¯»é¡¹é£™çš„ä¹¦ï¼Œéå¸¸æ¨èã€‚",
      "æ•°æ®æ”¶é›†çš„è¿‡ç¨‹å¾ˆæ¯ç‡¥ï¼Œä½†åˆ†æçš„æ—¶å€™ç‰¹åˆ«æœ‰æˆå°±æ„Ÿã€‚",
      "è¯´çœŸçš„ï¼Œæˆ‘è§‰å¾—äººä¸äººä¹‹é—´çš„ä¿¡ä»»è¶Šæ¥è¶Šéš¾å»ºç«‹äº†ã€‚",
    ],
  };

  const replies = replyMap[persona.id] || replyMap[1];
  const idx = Math.min(state.msgCount - 1, replies.length - 1);
  return replies[Math.max(0, idx)];
}

// ===== TRAIT INFERENCE =====
async function inferTraits() {
  if (!state.demoMode && state.apiKey) {
    try {
      const convo = state.messages.map(m => `${m.role === 'user' ? 'æˆ‘' : state.currentPersona.name}: ${m.content}`).join('\n');
      const prompt = `åˆ†æä»¥ä¸‹å¯¹è¯ï¼Œæ¨æ–­"${state.currentPersona.name}"çš„ç‰¹å¾ã€‚\n\n${convo}\n\nè¯·ä¸¥æ ¼ç”¨ä»¥ä¸‹JSONæ ¼å¼è¿”å›(ä¸è¦å…¶ä»–æ–‡å­—):\n{"gender":"ç”·/å¥³","mbti":"XXXX","openness":0.7,"conscientiousness":0.5,"extraversion":0.8,"agreeableness":0.6,"neuroticism":0.3,"emotion":"å½“å‰ä¸»è¦æƒ…ç»ª","is_bot_probability":0.5,"risk_level":0}`;

      let result;
      if (state.apiProvider === 'anthropic') {
        const res = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'x-api-key': state.apiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' },
          body: JSON.stringify({ model: 'claude-sonnet-4-20250514', max_tokens: 500, messages: [{ role: 'user', content: prompt }] })
        });
        const data = await res.json();
        result = JSON.parse(data.content[0].text.replace(/```json|```/g, '').trim());
      } else {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${state.apiKey}` },
          body: JSON.stringify({ model: 'gpt-4o-mini', max_tokens: 500, messages: [{ role: 'user', content: prompt }] })
        });
        const data = await res.json();
        result = JSON.parse(data.choices[0].message.content.replace(/```json|```/g, '').trim());
      }

      state.inferredTraits = result;
      renderTraits(result);
      return;
    } catch(e) {
      console.error('Inference error:', e);
    }
  }

  // Demo mode inference
  const demoTraits = {
    1: { gender: "å¥³", mbti: "ENFP", openness: 0.85, conscientiousness: 0.45, extraversion: 0.9, agreeableness: 0.8, neuroticism: 0.35, emotion: "å¼€å¿ƒ/å…´å¥‹", is_bot_probability: 0.6, risk_level: 0 },
    2: { gender: "ç”·", mbti: "INTJ", openness: 0.75, conscientiousness: 0.9, extraversion: 0.35, agreeableness: 0.5, neuroticism: 0.25, emotion: "å¹³é™/ç†æ€§", is_bot_probability: 0.5, risk_level: 0 },
    3: { gender: "å¥³", mbti: "INFP", openness: 0.95, conscientiousness: 0.55, extraversion: 0.3, agreeableness: 0.85, neuroticism: 0.7, emotion: "æ„Ÿæ€§/è½»å¾®ç„¦è™‘", is_bot_probability: 0.45, risk_level: 0 },
    4: { gender: "ç”·", mbti: "ESFP", openness: 0.6, conscientiousness: 0.65, extraversion: 0.95, agreeableness: 0.75, neuroticism: 0.2, emotion: "ç§¯æ/é˜³å…‰", is_bot_probability: 0.3, risk_level: 0 },
    5: { gender: "å¥³", mbti: "INFJ", openness: 0.9, conscientiousness: 0.8, extraversion: 0.4, agreeableness: 0.7, neuroticism: 0.5, emotion: "æ€è€ƒ/ä¸“æ³¨", is_bot_probability: 0.35, risk_level: 0 },
  };

  // Add some randomness at 20 msgs
  const traits = { ...demoTraits[state.currentPersona.id] };
  if (state.msgCount >= 20) {
    traits.openness = Math.min(1, traits.openness + (Math.random() * 0.1 - 0.05));
    traits.is_bot_probability = state.currentPersona.isBot ?
      Math.min(0.9, traits.is_bot_probability + 0.15) :
      Math.max(0.1, traits.is_bot_probability - 0.1);
  }

  state.inferredTraits = traits;
  renderTraits(traits);
}

function renderTraits(traits) {
  const container = document.getElementById('traitsContainer');
  const traitNames = {
    openness: 'å¼€æ”¾æ€§', conscientiousness: 'å°½è´£æ€§',
    extraversion: 'å¤–å‘æ€§', agreeableness: 'å®œäººæ€§', neuroticism: 'ç¥ç»è´¨'
  };

  container.innerHTML = `
    <div class="trait-row">
      <span class="trait-label">æ€§åˆ«</span>
      <span class="trait-value">${traits.gender || '?'}</span>
    </div>
    <div class="trait-row">
      <span class="trait-label">MBTI</span>
      <span class="trait-value">${traits.mbti || '????'}</span>
    </div>
    ${Object.entries(traitNames).map(([key, label]) => `
      <div class="trait-row">
        <span class="trait-label">${label}</span>
        <div class="trait-bar"><div class="trait-bar-fill" style="width:${(traits[key]||0.5)*100}%"></div></div>
        <span class="trait-value">${Math.round((traits[key]||0.5)*100)}%</span>
      </div>
    `).join('')}
    <div class="trait-row" style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border)">
      <span class="trait-label">AI æ¦‚ç‡</span>
      <span class="trait-value" style="color:${(traits.is_bot_probability||0) > 0.5 ? 'var(--warning)' : 'var(--accent)'}">${Math.round((traits.is_bot_probability||0.5)*100)}%</span>
    </div>
  `;

  // Emotion
  const emotionEl = document.getElementById('emotionContainer');
  const emotion = traits.emotion || 'æœªçŸ¥';
  const isNeg = ['ç„¦è™‘','æ„¤æ€’','æ‚²ä¼¤','ææƒ§'].some(e => emotion.includes(e));
  emotionEl.innerHTML = `<span class="emotion-tag ${isNeg ? 'negative' : ''}">${emotion}</span>`;

  // Risk
  if (traits.risk_level > 0.5) {
    document.getElementById('riskAlert').style.display = 'block';
    document.getElementById('riskText').textContent = 'æ£€æµ‹åˆ°å¼‚å¸¸ç¤¾äº¤æ¨¡å¼ï¼Œè¯·æ³¨æ„é˜²èŒƒã€‚';
  }
}

// ===== RESULTS =====
function showResults() {
  if (Object.keys(state.inferredTraits).length === 0) inferTraits();

  setTimeout(() => {
    const t = state.inferredTraits;
    const p = state.currentPersona;

    document.getElementById('resultGrid').innerHTML = `
      <div class="result-card">
        <h3>ğŸ­ çœŸå®èº«ä»½</h3>
        <div class="result-big">${p.name}</div>
        <div class="reveal-badge ${p.isBot ? 'bot' : 'human'}">
          ${p.isBot ? 'ğŸ¤– AI è§’è‰²' : 'âœ… çœŸäººç”¨æˆ·'}
        </div>
        <p class="result-desc">${p.isBot ? 'è¿™æ˜¯ä¸€ä¸ªç”±å¤§è¯­è¨€æ¨¡å‹é©±åŠ¨çš„è™šæ‹Ÿè§’è‰²ã€‚' : 'è¿™æ˜¯ä¸€ä½çœŸå®çš„äººç±»ç”¨æˆ·ã€‚'}</p>
      </div>
      <div class="result-card">
        <h3>ğŸ§¬ æ¨æ–­æ€§åˆ« & MBTI</h3>
        <div class="result-big">${t.gender || '?'} Â· ${t.mbti || '????'}</div>
        <p class="result-desc">åŸºäºå¯¹è¯ä¸­çš„è¯­è¨€é£æ ¼ã€æ€ç»´æ¨¡å¼å’Œæƒ…æ„Ÿè¡¨è¾¾æ¨æ–­ã€‚</p>
      </div>
      <div class="result-card">
        <h3>ğŸ“Š å¤§äº”äººæ ¼</h3>
        ${['openness:å¼€æ”¾æ€§', 'conscientiousness:å°½è´£æ€§', 'extraversion:å¤–å‘æ€§', 'agreeableness:å®œäººæ€§', 'neuroticism:ç¥ç»è´¨'].map(item => {
          const [key, label] = item.split(':');
          const val = Math.round((t[key] || 0.5) * 100);
          return `<div class="trait-row"><span class="trait-label">${label}</span><div class="trait-bar"><div class="trait-bar-fill" style="width:${val}%"></div></div><span class="trait-value">${val}%</span></div>`;
        }).join('')}
      </div>
      <div class="result-card">
        <h3>ğŸ’­ æƒ…ç»ªåˆ†æ</h3>
        <div class="result-big" style="font-size:24px">${t.emotion || 'æœªçŸ¥'}</div>
        <p class="result-desc">å¯¹è¯è¿‡ç¨‹ä¸­æ£€æµ‹åˆ°çš„ä¸»è¦æƒ…ç»ªçŠ¶æ€ã€‚</p>
      </div>
      <div class="result-card">
        <h3>ğŸ¤– AI æ£€æµ‹</h3>
        <div class="result-big">${Math.round((t.is_bot_probability || 0.5) * 100)}%</div>
        <p class="result-desc">ç³»ç»Ÿåˆ¤æ–­å¯¹æ–¹æ˜¯ AI çš„æ¦‚ç‡ã€‚${p.isBot ? 'ï¼ˆå®é™…ï¼šæ˜¯AIï¼‰' : 'ï¼ˆå®é™…ï¼šæ˜¯çœŸäººï¼‰'}</p>
      </div>
      <div class="result-card">
        <h3>ğŸ”® å…³ç³»é¢„æµ‹</h3>
        <div class="result-big" style="font-size:20px">${getRelationPrediction(t)}</div>
        <p class="result-desc">åŸºäºæ€§æ ¼åŒ¹é…åº¦å’Œäº’åŠ¨æ¨¡å¼çš„å…³ç³»èµ°å‘é¢„æµ‹ã€‚</p>
      </div>
    `;

    showScreen('resultScreen');
  }, 500);
}

function getRelationPrediction(traits) {
  const ext = traits.extraversion || 0.5;
  const agr = traits.agreeableness || 0.5;
  if (ext > 0.7 && agr > 0.6) return "é«˜äº’åŠ¨æ½œåŠ› Â· å¯èƒ½å‘å±•ä¸ºæ´»è·ƒå¥½å‹";
  if (ext < 0.4 && traits.openness > 0.7) return "æ·±åº¦äº¤æµå‹ Â· é€‚åˆæ€æƒ³ç¢°æ’";
  if (traits.neuroticism > 0.6) return "éœ€å…³æ³¨æƒ…ç»ª Â· å»ºè®®ç»™äºˆæ›´å¤šæ”¯æŒ";
  return "ç¨³å®šç¤¾äº¤ Â· æœ‰ä¸€å®šå‘å±•ç©ºé—´";
}
</script>
</body>
</html>