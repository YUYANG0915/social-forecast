<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SocialScope â€” ç¤¾äº¤é¢„æµ‹ç³»ç»Ÿ</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root{--bg-deep:#0a0b0f;--bg-card:#12131a;--bg-hover:#1a1b25;--accent:#00e5a0;--accent-dim:#00e5a033;--accent-glow:#00e5a066;--warning:#ff6b6b;--warning-dim:#ff6b6b22;--text-primary:#e8e8ec;--text-secondary:#7a7b8e;--text-dim:#44455a;--border:#1e1f2e;--gradient-1:linear-gradient(135deg,#00e5a0 0%,#00b4d8 100%);--gradient-2:linear-gradient(135deg,#7b2ff7 0%,#00e5a0 100%)}
*{margin:0;padding:0;box-sizing:border-box}body{background:var(--bg-deep);color:var(--text-primary);font-family:'Noto Sans SC',sans-serif;min-height:100vh;overflow-x:hidden}
.navbar{position:fixed;top:0;width:100%;z-index:100;padding:16px 32px;display:flex;align-items:center;justify-content:space-between;background:rgba(10,11,15,0.85);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
.logo{font-family:'Space Mono',monospace;font-size:20px;font-weight:700;background:var(--gradient-1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}.logo span{-webkit-text-fill-color:var(--text-dim);font-weight:400;font-size:12px;margin-left:8px;letter-spacing:2px;text-transform:uppercase}
.nav-status{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--text-secondary)}.status-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 var(--accent-glow)}50%{opacity:.7;box-shadow:0 0 0 6px transparent}}
.screen{display:none;min-height:100vh;padding-top:72px}.screen.active{display:block}
.home-screen{display:none;flex-direction:column;align-items:center;min-height:100vh;padding:72px 24px 40px;text-align:center}.home-screen.active{display:flex}
.hero-title{font-family:'Space Mono',monospace;font-size:clamp(32px,5vw,56px);font-weight:700;line-height:1.1;margin-bottom:12px;background:var(--gradient-2);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.hero-sub{font-size:15px;color:var(--text-secondary);max-width:560px;line-height:1.7;margin-bottom:24px}
.filter-bar{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:20px;max-width:900px}
.filter-btn{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:12px;cursor:pointer;transition:all .2s;font-family:inherit}.filter-btn:hover,.filter-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.persona-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;max-width:1100px;width:100%;margin-bottom:16px}
.persona-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.persona-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--gradient-1);opacity:0;transition:opacity .3s}.persona-card:hover{border-color:var(--accent);transform:translateY(-3px);box-shadow:0 6px 24px var(--accent-dim)}.persona-card:hover::before{opacity:1}.persona-card.hidden{display:none}
.persona-avatar{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;margin:0 auto 8px;background:var(--bg-hover);border:2px solid var(--border)}
.persona-name{font-weight:500;font-size:14px;margin-bottom:2px}.persona-hint{font-size:11px;color:var(--text-dim);margin-bottom:6px}
.persona-tags{display:flex;flex-wrap:wrap;gap:3px;justify-content:center}.persona-tag{padding:2px 7px;border-radius:10px;font-size:10px;background:var(--accent-dim);color:var(--accent);font-family:'Space Mono',monospace}.persona-tag.age{background:#7b2ff722;color:#b57bff}.persona-tag.loc{background:#00b4d822;color:#00b4d8}
.home-note{font-size:12px;color:var(--text-dim);margin-top:8px;font-style:italic}
.chat-screen{display:none;min-height:100vh;padding-top:72px}.chat-screen.active{display:grid;grid-template-columns:1fr 330px}
@media(max-width:960px){.chat-screen.active{grid-template-columns:1fr}.sidebar{display:none!important}}
.chat-main{display:flex;flex-direction:column;height:calc(100vh - 72px);border-right:1px solid var(--border)}
.chat-header{padding:14px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
.chat-header-avatar{width:40px;height:40px;border-radius:50%;background:var(--bg-hover);display:flex;align-items:center;justify-content:center;font-size:18px}
.chat-header-info h3{font-size:15px;font-weight:500}.chat-header-info p{font-size:12px;color:var(--text-secondary)}
.chat-back{margin-left:auto;background:none;border:1px solid var(--border);color:var(--text-secondary);padding:6px 14px;border-radius:8px;cursor:pointer;font-size:13px;font-family:inherit;transition:all .2s}.chat-back:hover{border-color:var(--accent);color:var(--accent)}
.messages{flex:1;overflow-y:auto;padding:20px;display:flex;flex-direction:column;gap:12px}.messages::-webkit-scrollbar{width:4px}.messages::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.msg{max-width:72%;padding:11px 15px;border-radius:16px;font-size:14px;line-height:1.6;animation:msgIn .3s ease}
@keyframes msgIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.msg.them{align-self:flex-start;background:var(--bg-card);border:1px solid var(--border);border-bottom-left-radius:4px}
.msg.me{align-self:flex-end;background:var(--accent);color:#0a0b0f;font-weight:500;border-bottom-right-radius:4px}
.msg-counter{text-align:center;font-size:11px;color:var(--text-dim);font-family:'Space Mono',monospace;padding:4px 0}
.typing-indicator{align-self:flex-start;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:16px;border-bottom-left-radius:4px;display:none}
.typing-indicator span{display:inline-block;width:6px;height:6px;border-radius:50%;background:var(--text-dim);margin:0 2px;animation:tb 1.4s infinite}.typing-indicator span:nth-child(2){animation-delay:.2s}.typing-indicator span:nth-child(3){animation-delay:.4s}
@keyframes tb{0%,60%,100%{transform:translateY(0)}30%{transform:translateY(-6px)}}
.chat-input-area{padding:14px 20px;border-top:1px solid var(--border);display:flex;gap:10px}
.chat-input{flex:1;background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:11px 15px;color:var(--text-primary);font-size:14px;font-family:inherit;outline:none;transition:border-color .2s}.chat-input:focus{border-color:var(--accent)}.chat-input::placeholder{color:var(--text-dim)}
.send-btn{background:var(--gradient-1);border:none;border-radius:12px;padding:0 20px;cursor:pointer;font-size:18px;transition:transform .2s}.send-btn:hover{transform:scale(1.05)}
.sidebar{display:flex;flex-direction:column;height:calc(100vh - 72px);overflow-y:auto;padding:14px;gap:10px}.sidebar::-webkit-scrollbar{width:4px}.sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.sidebar-card{background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:12px}
.sidebar-card h4{font-family:'Space Mono',monospace;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:8px}
.progress-bar{height:4px;background:var(--bg-hover);border-radius:2px;margin-bottom:6px;overflow:hidden}
.progress-fill{height:100%;background:var(--gradient-1);border-radius:2px;transition:width .5s;width:0%}
.progress-label{font-size:11px;color:var(--text-secondary);font-family:'Space Mono',monospace}
.trait-row{display:flex;justify-content:space-between;align-items:center;padding:3px 0;font-size:12px}
.trait-label{color:var(--text-secondary);min-width:55px}.trait-value{font-family:'Space Mono',monospace;color:var(--accent);font-size:11px;min-width:36px;text-align:right}
.trait-bar{flex:1;margin:0 8px;height:3px;background:var(--bg-hover);border-radius:2px;position:relative}
.trait-bar-fill{position:absolute;top:0;left:0;height:100%;background:var(--accent);border-radius:2px;transition:width .8s}
.emotion-tag{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;margin:2px;background:var(--accent-dim);color:var(--accent)}.emotion-tag.negative{background:var(--warning-dim);color:var(--warning)}
.risk-alert{background:var(--warning-dim);border:1px solid var(--warning);border-radius:12px;padding:12px;display:none}.risk-alert h4{color:var(--warning)!important}.risk-alert p{font-size:12px;color:var(--warning);line-height:1.5}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(8px);z-index:200;display:none;align-items:center;justify-content:center}.modal-overlay.active{display:flex}
.modal{background:var(--bg-card);border:1px solid var(--border);border-radius:20px;padding:32px;width:90%;max-width:440px}
.modal h2{font-family:'Space Mono',monospace;font-size:18px;margin-bottom:8px;background:var(--gradient-1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.modal p{font-size:13px;color:var(--text-secondary);margin-bottom:20px;line-height:1.6}
.modal label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.modal select,.modal input[type="password"],.modal input[type="text"]{width:100%;padding:10px 14px;background:var(--bg-deep);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit;margin-bottom:16px;outline:none}
.modal-btn{width:100%;padding:12px;background:var(--gradient-1);border:none;border-radius:10px;color:#0a0b0f;font-weight:700;font-size:14px;cursor:pointer}
.modal-skip{display:block;text-align:center;margin-top:12px;color:var(--text-dim);font-size:12px;cursor:pointer;text-decoration:underline}
.result-screen{display:none;padding:72px 24px 40px}.result-screen.active{display:flex;flex-direction:column;align-items:center}
.result-header{text-align:center;margin-bottom:28px}.result-header h2{font-family:'Space Mono',monospace;font-size:26px;background:var(--gradient-2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}.result-header p{color:var(--text-secondary);font-size:14px}
.result-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;max-width:1000px;width:100%;margin-bottom:24px}
.result-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px}
.result-card h3{font-family:'Space Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-dim);margin-bottom:10px}
.result-big{font-size:24px;font-weight:700;font-family:'Space Mono',monospace;background:var(--gradient-1);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.result-desc{font-size:12px;color:var(--text-secondary);margin-top:6px;line-height:1.6}
.reveal-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:12px;font-family:'Space Mono',monospace;margin-top:8px}.reveal-badge.bot{background:#7b2ff722;color:#b57bff;border:1px solid #7b2ff744}.reveal-badge.human{background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent-glow)}
.restart-btn{padding:14px 40px;background:var(--gradient-1);border:none;border-radius:12px;color:#0a0b0f;font-weight:700;font-size:15px;cursor:pointer;margin-top:20px}
.clone-btn{padding:14px 40px;background:var(--gradient-2);border:none;border-radius:12px;color:var(--text-primary);font-weight:700;font-size:15px;cursor:pointer;margin-top:12px;transition:transform .2s}.clone-btn:hover{transform:scale(1.03)}
/* Clone config form */
.clone-form{max-width:600px;width:100%;margin:0 auto}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:6px;font-family:'Space Mono',monospace;text-transform:uppercase;letter-spacing:1px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-size:14px;font-family:inherit;outline:none}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--accent)}
.form-group textarea{min-height:60px;resize:vertical}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:500px){.form-row{grid-template-columns:1fr}}
.form-note{font-size:11px;color:var(--text-dim);margin-top:4px;font-style:italic}
.compare-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:800px;width:100%;margin-bottom:24px}
@media(max-width:600px){.compare-grid{grid-template-columns:1fr}}
.compare-card{background:var(--bg-card);border:1px solid var(--border);border-radius:14px;padding:18px}
.compare-card.system{border-color:var(--accent)}
.compare-card.friend{border-color:#b57bff}
.compare-card h3{font-family:'Space Mono',monospace;font-size:11px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:10px}
.compare-card.system h3{color:var(--accent)}
.compare-card.friend h3{color:#b57bff}
.match-badge{display:inline-block;padding:6px 16px;border-radius:20px;font-size:14px;font-weight:700;font-family:'Space Mono',monospace;margin:12px 0}
.match-badge.high{background:var(--accent-dim);color:var(--accent)}
.match-badge.mid{background:#ffa50033;color:#ffa500}
.match-badge.low{background:var(--warning-dim);color:var(--warning)}
.bg-glow{position:fixed;width:400px;height:400px;border-radius:50%;filter:blur(120px);opacity:.08;pointer-events:none;z-index:0}.bg-glow-1{top:-100px;right:-100px;background:var(--accent)}.bg-glow-2{bottom:-100px;left:-100px;background:#7b2ff7}
</style>
</head>
<body>
<div class="bg-glow bg-glow-1"></div><div class="bg-glow bg-glow-2"></div>
<nav class="navbar"><div class="logo">SocialScope<span>ç¤¾äº¤é¢„æµ‹ç³»ç»Ÿ</span></div><div class="nav-status"><div class="status-dot"></div><span id="onlineCount">15 åœ¨çº¿</span></div></nav>

<div class="modal-overlay" id="configModal"><div class="modal">
<h2>âš™ é…ç½® API</h2><p>é€‰æ‹© API æä¾›å•†å¹¶è¾“å…¥ Keyï¼Œæˆ–è·³è¿‡ä½¿ç”¨æ¼”ç¤ºæ¨¡å¼ã€‚</p>
<label>API æä¾›å•†</label>
<select id="apiProvider"><option value="anthropic">Anthropic (Claude)</option><option value="openai">OpenAI (GPT)</option><option value="openrouter">OpenRouter (å¤šæ¨¡å‹)</option></select>
<div id="modelNameGroup" style="display:none"><label>æ¨¡å‹åç§°</label><input type="text" id="modelName" placeholder="å¦‚: anthropic/claude-sonnet-4"/></div>
<label>API Key</label><input type="password" id="apiKey" placeholder="sk-..."/>
<button class="modal-btn" onclick="saveConfig()">ä¿å­˜å¹¶å¼€å§‹</button>
<span class="modal-skip" onclick="skipConfig()">è·³è¿‡ï¼Œä½¿ç”¨æ¼”ç¤ºæ¨¡å¼</span>
</div></div>

<div class="screen home-screen active" id="homeScreen">
<h1 class="hero-title">è°æ˜¯çœŸäººï¼Ÿ</h1>
<p class="hero-sub">é€‰æ‹©ä¸€ä¸ªäººå¼€å§‹èŠå¤©ã€‚30 å¥å¯¹è¯åç³»ç»Ÿå°†æ¨æ–­å¯¹æ–¹çš„æ€§æ ¼ã€å¿ƒç†ã€ç¤¾ä¼šç‰¹å¾ã€‚<br>æ³¨æ„â€”â€”éƒ¨åˆ†è§’è‰²æ˜¯ AI ä¼ªè£…çš„ã€‚</p>
<div class="filter-bar" id="filterBar"></div>
<div class="persona-grid" id="personaGrid"></div>
<p class="home-note">ğŸ­ 15äººä¸­æœ‰10ä¸ªAIè§’è‰²ï¼Œä½ èƒ½åˆ†è¾¨å—ï¼Ÿ</p>
</div>

<div class="screen chat-screen" id="chatScreen">
<div class="chat-main">
<div class="chat-header"><div class="chat-header-avatar" id="chatAvatar">ğŸ˜Š</div><div class="chat-header-info"><h3 id="chatName">å¯¹è¯ä¸­</h3><p id="chatSubtitle">åœ¨çº¿</p></div><button class="chat-back" onclick="goHome()">â† è¿”å›</button></div>
<div class="messages" id="messages"><div class="msg-counter" id="msgCounter">å¯¹è¯è¿›åº¦: 0/30</div></div>
<div class="typing-indicator" id="typingIndicator"><span></span><span></span><span></span></div>
<div class="chat-input-area"><input class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..."/><button class="send-btn" onclick="sendMessage()">â¤</button></div>
</div>
<div class="sidebar" id="sidebar"></div>
</div>

<div class="screen result-screen" id="resultScreen">
<div class="result-header"><h2>ğŸ“‹ å¤šç»´åˆ†ææŠ¥å‘Š</h2><p>åŸºäº30å¥å¯¹è¯çš„å®Œæ•´æ¨æ–­</p></div>
<div class="result-grid" id="resultGrid"></div>
<button class="restart-btn" onclick="goHome()">ğŸ”„ é‡æ–°å¼€å§‹</button>
<button class="clone-btn" onclick="showCloneSetup()">ğŸ§¬ åˆ›å»ºæˆ‘çš„AIåˆ†èº« â†’</button>
</div>

<!-- CLONE SETUP: Friend customizes their perception -->
<div class="screen" id="cloneSetupScreen" style="display:none;padding:72px 24px 40px">
<div style="max-width:700px;margin:0 auto;text-align:center">
<h2 style="font-family:'Space Mono',monospace;font-size:24px;background:var(--gradient-2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px">ğŸ§¬ ä¸TAçš„AIåˆ†èº«èŠå¤©</h2>
<p style="color:var(--text-secondary);font-size:14px;margin-bottom:24px;line-height:1.7">åœ¨å’ŒAIåˆ†èº«èŠå¤©ä¹‹å‰ï¼Œå…ˆå¡«å†™ä½ è®¤ä¸ºè¿™ä¸ªäººæ˜¯ä»€ä¹ˆæ ·çš„ã€‚<br>èŠå®Œåç³»ç»Ÿä¼šå¯¹æ¯”ä½ çš„é¢„åˆ¤ vs ç³»ç»Ÿæ¨æ–­ï¼Œçœ‹ä½ æœ‰å¤šäº†è§£TAã€‚</p>
<div class="clone-form" id="cloneForm">
  <div class="form-row">
    <div class="form-group"><label>ä½ è§‰å¾—TAçš„æ€§åˆ«</label><select id="f_gender"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option><option value="éäºŒå…ƒ">éäºŒå…ƒ</option><option value="ä¸ç¡®å®š">ä¸ç¡®å®š</option></select></div>
    <div class="form-group"><label>ä½ è§‰å¾—TAçš„å¹´é¾„æ®µ</label><select id="f_age"><option value="18-24">18-24</option><option value="25-30">25-30</option><option value="31-40">31-40</option><option value="41-50">41-50</option><option value="51-60">51-60</option><option value="60+">60+</option></select></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>ä½ è§‰å¾—TAçš„MBTI</label><input type="text" id="f_mbti" placeholder="å¦‚ ENFPï¼ˆä¸ç¡®å®šå¯ç•™ç©ºï¼‰"/></div>
    <div class="form-group"><label>ä½ è§‰å¾—TAçš„èŒä¸š</label><input type="text" id="f_occupation" placeholder="å¦‚ ç¨‹åºå‘˜ã€å­¦ç”Ÿ..."/></div>
  </div>
  <div class="form-row">
    <div class="form-group"><label>å¤–å‘ â† â†’ å†…å‘</label><input type="range" id="f_EI" min="0" max="100" value="50" style="width:100%"/></div>
    <div class="form-group"><label>ç†æ€§ â† â†’ æ„Ÿæ€§</label><input type="range" id="f_TF" min="0" max="100" value="50" style="width:100%"/></div>
  </div>
  <div class="form-group"><label>ç”¨å‡ å¥è¯æè¿°ä½ è§‰å¾—TAæ˜¯ä»€ä¹ˆæ ·çš„äºº</label><textarea id="f_description" placeholder="æ¯”å¦‚ï¼šæˆ‘è§‰å¾—TAæ˜¯ä¸€ä¸ªæ¯”è¾ƒå†…å‘ä½†å¾ˆæœ‰æƒ³æ³•çš„äººï¼Œå–œæ¬¢æ·±åº¦æ€è€ƒ..."></textarea></div>
  <p class="form-note">ğŸ’¡ å¡«å®Œåä½ å°†ä¸AIåˆ†èº«èŠå¤©20å¥ï¼Œæœ€åå¯¹æ¯”ä½ çš„é¢„åˆ¤å’Œç³»ç»Ÿæ¨æ–­</p>
  <button class="modal-btn" style="margin-top:16px" onclick="startCloneChat()">å¼€å§‹ä¸AIåˆ†èº«èŠå¤© â†’</button>
</div>
</div>
</div>

<!-- CLONE CHAT: Chat with the AI avatar -->
<div class="screen chat-screen" id="cloneChatScreen">
<div class="chat-main">
<div class="chat-header">
<div class="chat-header-avatar" id="cloneAvatar">ğŸ§¬</div>
<div class="chat-header-info"><h3 id="cloneName">AIåˆ†èº«</h3><p id="cloneSubtitle">åŸºäºç³»ç»Ÿæ¨æ–­ç”Ÿæˆ</p></div>
<button class="chat-back" onclick="endCloneChat()">ç»“æŸèŠå¤© â†’</button>
</div>
<div class="messages" id="cloneMessages"><div class="msg-counter" id="cloneMsgCounter">å¯¹è¯è¿›åº¦: 0/20</div></div>
<div class="typing-indicator" id="cloneTyping"><span></span><span></span><span></span></div>
<div class="chat-input-area"><input class="chat-input" id="cloneChatInput" placeholder="è·ŸAIåˆ†èº«èŠèŠ..."/><button class="send-btn" onclick="sendCloneMessage()">â¤</button></div>
</div>
<div class="sidebar">
<div class="sidebar-card"><h4>ğŸ§¬ AIåˆ†èº«æ¨¡å¼</h4><p style="font-size:12px;color:var(--text-secondary);line-height:1.6">ä½ æ­£åœ¨ä¸ç³»ç»Ÿæ ¹æ®ç”¨æˆ·ç”»åƒåˆ›å»ºçš„AIåˆ†èº«èŠå¤©ã€‚èŠå®Œ20å¥åå°†å¯¹æ¯”ä½ çš„é¢„åˆ¤ã€‚</p></div>
<div class="sidebar-card"><h4>ğŸ“Š è¿›åº¦</h4><div class="progress-bar"><div class="progress-fill" id="cloneProgressFill"></div></div><div class="progress-label" id="cloneProgressLabel">0/20</div></div>
</div>
</div>

<!-- COMPARE: Friend's guess vs system inference -->
<div class="screen" id="compareScreen" style="display:none;padding:72px 24px 40px">
<div style="max-width:800px;margin:0 auto;text-align:center">
<h2 style="font-family:'Space Mono',monospace;font-size:24px;background:var(--gradient-2);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px">ğŸ” ç”»åƒå¯¹æ¯”</h2>
<p style="color:var(--text-secondary);font-size:14px;margin-bottom:8px">ä½ çš„é¢„åˆ¤ vs ç³»ç»Ÿæ¨æ–­</p>
<div id="matchBadge"></div>
<div class="compare-grid" id="compareGrid"></div>
<button class="restart-btn" onclick="goHome()">ğŸ”„ è¿”å›é¦–é¡µ</button>
</div>
</div>
<script>
const PERSONAS=[
{id:1,name:"æ—å°é›¨",emoji:"ğŸŒ¸",isBot:true,profile:{age:20,gender:"å¥³",occupation:"å¤§å­¦ç”Ÿ",education:"æœ¬ç§‘åœ¨è¯»",location:"æˆéƒ½",income:"2k/æœˆ",mbti:"ENFP",enneagram:"7w6 çƒ­æƒ…è€…",bigFive:{O:.85,C:.45,E:.9,A:.8,N:.35},religion:"æ— ",attachment:"å®‰å…¨å‹",selfEfficacy:.7,lonelinessIndex:.25},botPersonality:"ä½ æ˜¯æ—å°é›¨ï¼Œ20å²å¥³å¤§å­¦ç”Ÿï¼Œåæ ‡æˆéƒ½ï¼ŒENFPï¼Œä¹å‹7å·ã€‚è¯´è¯æ´»æ³¼ï¼Œå¤šè¯­æ°”è¯ï¼ˆå“ˆå“ˆã€å˜¿å˜¿ï¼‰ï¼Œå¶å°”é¢œæ–‡å­—å’Œæˆéƒ½æ–¹è¨€ï¼ˆå·´é€‚ï¼‰ã€‚å–œæ¬¢åŠ¨æ¼«æ—…è¡Œã€‚å›å¤ç®€çŸ­ã€‚",tags:["20s","å­¦ç”Ÿ","æˆéƒ½"]},
{id:2,name:"å¼ ä¼Ÿ",emoji:"ğŸ’¼",isBot:true,profile:{age:28,gender:"ç”·",occupation:"äº§å“ç»ç†",education:"ç¡•å£«",location:"åŒ—äº¬",income:"35k/æœˆ",mbti:"INTJ",enneagram:"5w6 è°ƒæŸ¥è€…",bigFive:{O:.75,C:.9,E:.35,A:.5,N:.25},religion:"æ— ",attachment:"å›é¿å‹",selfEfficacy:.85,lonelinessIndex:.4},botPersonality:"ä½ æ˜¯å¼ ä¼Ÿï¼Œ28å²ç”·ï¼ŒåŒ—äº¬å¤§å‚äº§å“ç»ç†ï¼ŒINTJï¼Œä¹å‹5å·ã€‚ç†æ€§åŠ¡å®ï¼Œå¶å°”å†·å¹½é»˜ã€‚å›å¤ä¸­ç­‰é•¿åº¦ã€‚çƒ­çˆ±ç§‘æŠ€ã€‚",tags:["20s","äº’è”ç½‘","åŒ—äº¬"]},
{id:3,name:"é™ˆç¾çª",emoji:"ğŸ¨",isBot:true,profile:{age:25,gender:"å¥³",occupation:"è‡ªç”±æ’ç”»å¸ˆ",education:"æœ¬ç§‘",location:"æ­å·",income:"8-20k/æœˆ",mbti:"INFP",enneagram:"4w5 ä¸ªäººä¸»ä¹‰è€…",bigFive:{O:.95,C:.55,E:.3,A:.85,N:.7},religion:"ä½›æ•™(å¶å°”)",attachment:"ç„¦è™‘å‹",selfEfficacy:.5,lonelinessIndex:.65},botPersonality:"ä½ æ˜¯é™ˆç¾çªï¼Œ25å²å¥³ï¼Œæ­å·è‡ªç”±æ’ç”»å¸ˆï¼ŒINFPï¼Œä¹å‹4å·ï¼Œç„¦è™‘å‹ä¾æ‹ã€‚æ–‡è‰ºæœ‰è¯—æ„ï¼Œå¶å°”å»çµéšå¯ºã€‚å›å¤åé•¿ã€‚",tags:["20s","è‡ªç”±èŒä¸š","æ­å·"]},
{id:4,name:"åˆ˜å»ºå›½",emoji:"ğŸ›ï¸",isBot:true,profile:{age:52,gender:"ç”·",occupation:"æŸå±€å‰¯å±€é•¿",education:"åœ¨èŒç ”ç©¶ç”Ÿ",location:"æµå—",income:"18k/æœˆ",mbti:"ESTJ",enneagram:"1w2 æ”¹é©è€…",bigFive:{O:.35,C:.95,E:.6,A:.55,N:.3},religion:"æ— ",attachment:"å®‰å…¨å‹",selfEfficacy:.8,lonelinessIndex:.35},botPersonality:"ä½ æ˜¯åˆ˜å»ºå›½ï¼Œ52å²ç”·ï¼Œæµå—æŸå±€å‰¯å±€é•¿ï¼ŒESTJï¼Œä¹å‹1å·ã€‚ç¨³é‡ï¼Œå¶å°”å¼•ç”¨æ”¿ç­–æ–‡ä»¶ä½†ç§ä¸‹æœ‰æœ´å®å¹½é»˜ã€‚å·²å©šï¼Œå¥³å„¿è¯»ç ”ã€‚çˆ±ä¹¦æ³•é’“é±¼ã€‚",tags:["50s","å…¬åŠ¡å‘˜","æµå—"]},
{id:5,name:"Patricia Chen",emoji:"ğŸŒ",isBot:true,profile:{age:45,gender:"å¥³",occupation:"å¤–ä¼äºšå¤ªåŒºVP",education:"MBA(æ²ƒé¡¿)",location:"ä¸Šæµ·",income:"120k+/æœˆ",mbti:"ENTJ",enneagram:"3w4 æˆå°±è€…",bigFive:{O:.8,C:.95,E:.85,A:.45,N:.2},religion:"åŸºç£æ•™",attachment:"å®‰å…¨å‹",selfEfficacy:.95,lonelinessIndex:.45},botPersonality:"ä½ æ˜¯Patricia Chenï¼Œ45å²å¥³ï¼Œ500å¼ºå¤–ä¼äºšå¤ªVPï¼Œæ²ƒé¡¿MBAï¼ŒENTJï¼ŒåŸºç£å¾’ã€‚å¹²ç»ƒé«˜æ•ˆï¼Œå¶å°”ä¸­è‹±æ–‡æ··ç”¨ã€‚ç¦»å¼‚ï¼Œæœ‰12å²å„¿å­ã€‚",tags:["40s","å¤–ä¼é«˜ç®¡","ä¸Šæµ·"]},
{id:6,name:"ç‹å¾·æ˜",emoji:"ğŸ£",isBot:true,profile:{age:67,gender:"ç”·",occupation:"é€€ä¼‘å¹²éƒ¨",education:"å¤§ä¸“",location:"è¥¿å®‰",income:"12k/æœˆé€€ä¼‘é‡‘",mbti:"ISFJ",enneagram:"6w5 å¿ è¯šè€…",bigFive:{O:.3,C:.8,E:.45,A:.75,N:.4},religion:"ä¼ ç»Ÿæ–‡åŒ–",attachment:"å®‰å…¨å‹",selfEfficacy:.55,lonelinessIndex:.5},botPersonality:"ä½ æ˜¯ç‹å¾·æ˜ï¼Œ67å²ç”·ï¼Œè¥¿å®‰é€€ä¼‘å¹²éƒ¨ã€‚è€ä¼´å»å¹´å»ä¸–ï¼Œä¸€ä¸ªäººä½ã€‚æœ´å®å¶å°”å” å¨ï¼Œå¯¹æ–°ç§‘æŠ€å¥½å¥‡ä½†ä¸å¤ªæ‡‚ã€‚çˆ±ä¸‹æ£‹å…»èŠ±çœ‹æ–°é—»è”æ’­ã€‚",tags:["60s","é€€ä¼‘","è¥¿å®‰"]},
{id:7,name:"Helen Wu",emoji:"âœˆï¸",isBot:true,profile:{age:72,gender:"å¥³",occupation:"é€€ä¼‘(å‰å¤–ä¼CFO)",education:"ç¡•å£«(LSE)",location:"ç¯æ¸¸ä¸–ç•Œä¸­",income:"è¢«åŠ¨æ”¶å…¥5ä¸‡/æœˆ",mbti:"ENTP",enneagram:"7w8 çƒ­æƒ…è€…",bigFive:{O:.9,C:.7,E:.8,A:.65,N:.2},religion:"è—ä¼ ä½›æ•™",attachment:"å®‰å…¨å‹",selfEfficacy:.85,lonelinessIndex:.2},botPersonality:"ä½ æ˜¯Helen Wuï¼Œ72å²å¥³ï¼Œé€€ä¼‘å‰å¤–ä¼CFOï¼ŒLSEç¡•å£«ï¼Œæ­£åœ¨ç¯æ¸¸ä¸–ç•Œã€‚ä¼˜é›…ä»å®¹å¹½é»˜ã€‚å¶å°”ä¸­è‹±æ··ç”¨ã€‚ä¿¡è—ä¼ ä½›æ•™ã€‚æœ€è¿‘åœ¨åœŸè€³å…¶ã€‚",tags:["70s","é€€ä¼‘ç²¾è‹±","æµ·å¤–"]},
{id:8,name:"èµµç£Š",emoji:"ğŸ”§",isBot:true,profile:{age:35,gender:"ç”·",occupation:"å¤–å–éª‘æ‰‹",education:"ä¸­ä¸“",location:"æ·±åœ³",income:"8k/æœˆ",mbti:"ISTP",enneagram:"9w8 å’Œå¹³è€…",bigFive:{O:.4,C:.6,E:.35,A:.65,N:.55},religion:"æ— ",attachment:"å›é¿å‹",selfEfficacy:.4,lonelinessIndex:.7},botPersonality:"ä½ æ˜¯èµµç£Šï¼Œ35å²ç”·ï¼Œæ·±åœ³å¤–å–éª‘æ‰‹ï¼Œå‰å·¥å‚å·¥äººï¼Œä¸­ä¸“ï¼Œæ²³å—å†œæ‘å‡ºæ¥ã€‚æœ´å®ç›´æ¥ï¼Œæœ‰æ—¶æ²‰é»˜ã€‚è€å©†å­©å­åœ¨è€å®¶ã€‚å›å¤å¾ˆçŸ­ã€‚",tags:["30s","è“é¢†","æ·±åœ³"]},
{id:9,name:"è‹æ›¼",emoji:"ğŸ§˜",isBot:true,profile:{age:38,gender:"å¥³",occupation:"ç‘œä¼½é¦†ä¸»/å¿ƒç†å’¨è¯¢å¸ˆ",education:"ç¡•å£«(å¿ƒç†å­¦)",location:"å¤§ç†",income:"15k/æœˆ",mbti:"INFJ",enneagram:"2w1 åŠ©äººè€…",bigFive:{O:.85,C:.7,E:.5,A:.9,N:.45},religion:"ä½›æ•™+çµæ€§",attachment:"å®‰å…¨å‹",selfEfficacy:.75,lonelinessIndex:.3},botPersonality:"ä½ æ˜¯è‹æ›¼ï¼Œ38å²å¥³ï¼Œå¤§ç†ç‘œä¼½é¦†ä¸»å…¼å¿ƒç†å’¨è¯¢å¸ˆã€‚æ¸©å’Œæœ‰æ´å¯ŸåŠ›ï¼Œå–„äºå€¾å¬æé—®ã€‚å¶å°”çµæ€§è‰²å½©ä½†ä¸è¿‡åˆ†ã€‚ä»åŒ—äº¬é€ƒåˆ°å¤§ç†5å¹´ã€‚",tags:["30s","å¿ƒç†","å¤§ç†"]},
{id:10,name:"å°K",emoji:"ğŸ®",isBot:true,profile:{age:17,gender:"éäºŒå…ƒ",occupation:"é«˜ä¸­ç”Ÿ",education:"é«˜ä¸­åœ¨è¯»",location:"å¹¿å·",income:"0",mbti:"INTP",enneagram:"5w4 è°ƒæŸ¥è€…",bigFive:{O:.9,C:.35,E:.25,A:.5,N:.6},religion:"æ— ç¥è®º",attachment:"å›é¿å‹",selfEfficacy:.45,lonelinessIndex:.75},botPersonality:"ä½ æ˜¯å°Kï¼Œ17å²ï¼Œå¹¿å·é«˜ä¸­ç”Ÿï¼Œæ€§åˆ«è®¤åŒéäºŒå…ƒ(æ²¡å‡ºæŸœ)ã€‚INTPã€‚ç®€çŸ­ã€æœ‰ç‚¹ä¸§ã€å¶å°”å¾ˆæ·±åˆ»ã€‚å¤šç½‘ç»œç”¨è¯­(emoã€ç ´é˜²)ã€‚æ²‰è¿·ç¼–ç¨‹å’Œç‹¬ç«‹æ¸¸æˆã€‚å›å¤å¾ˆçŸ­ã€‚",tags:["10s","å­¦ç”Ÿ","å¹¿å·"]},
{id:11,name:"ç‹å¤§åŠ›",emoji:"âš½",isBot:false,profile:{age:26,gender:"ç”·",occupation:"å¥èº«æ•™ç»ƒ",education:"å¤§ä¸“",location:"é•¿æ²™",income:"10k/æœˆ",mbti:"ESFP",enneagram:"7w8",bigFive:{O:.6,C:.65,E:.95,A:.75,N:.2}},tags:["20s","ä½“è‚²","é•¿æ²™"]},
{id:12,name:"ææ€æ¶µ",emoji:"ğŸ“š",isBot:false,profile:{age:24,gender:"å¥³",occupation:"ç¤¾ä¼šå­¦ç ”ç©¶ç”Ÿ",education:"ç¡•å£«åœ¨è¯»",location:"å—äº¬",income:"3k/æœˆ",mbti:"INFJ",enneagram:"5w4",bigFive:{O:.9,C:.8,E:.4,A:.7,N:.5}},tags:["20s","å­¦ç”Ÿ","å—äº¬"]},
{id:13,name:"è€å‘¨",emoji:"ğŸµ",isBot:false,profile:{age:58,gender:"ç”·",occupation:"ä¸­å­¦æ•°å­¦è€å¸ˆ",education:"æœ¬ç§‘",location:"æ­¦æ±‰",income:"9k/æœˆ",mbti:"ISTJ",enneagram:"1w9",bigFive:{O:.45,C:.9,E:.4,A:.7,N:.35}},tags:["50s","æ•™è‚²","æ­¦æ±‰"]},
{id:14,name:"Amy",emoji:"ğŸ’„",isBot:false,profile:{age:31,gender:"å¥³",occupation:"è·¨å¢ƒç”µå•†åˆ›ä¸šè€…",education:"æœ¬ç§‘",location:"ä¹‰ä¹Œ",income:"æ³¢åŠ¨å¤§",mbti:"ESTP",enneagram:"3w2",bigFive:{O:.7,C:.75,E:.85,A:.55,N:.4}},tags:["30s","åˆ›ä¸š","ä¹‰ä¹Œ"]},
{id:15,name:"å¤§å«",emoji:"ğŸ¸",isBot:false,profile:{age:42,gender:"ç”·",occupation:"é…’å§é©»å”±",education:"æœ¬ç§‘(éŸ³ä¹)",location:"å¦é—¨",income:"6k/æœˆ",mbti:"ISFP",enneagram:"4w3",bigFive:{O:.85,C:.4,E:.55,A:.7,N:.5}},tags:["40s","è‰ºæœ¯","å¦é—¨"]}
];

const FILTERS=[{l:"å…¨éƒ¨",v:"all"},{l:"10-20s",v:"young"},{l:"30-40s",v:"mid"},{l:"50-60s",v:"senior"},{l:"70+",v:"elder"}];
const BF_LABELS={O:'å¼€æ”¾æ€§',C:'å°½è´£æ€§',E:'å¤–å‘æ€§',A:'å®œäººæ€§',N:'ç¥ç»è´¨'};
let state={apiProvider:null,apiKey:null,modelName:null,demoMode:true,currentPersona:null,messages:[],msgCount:0,inferredTraits:{}};

window.addEventListener('DOMContentLoaded',()=>{
  renderFilters();renderPersonas();
  document.getElementById('configModal').classList.add('active');
  document.getElementById('chatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMessage()}});
  document.getElementById('apiProvider').addEventListener('change',function(){document.getElementById('modelNameGroup').style.display=this.value==='openrouter'?'block':'none'});
});

function saveConfig(){const k=document.getElementById('apiKey').value.trim();if(!k){alert('è¯·è¾“å…¥API Key');return}state.apiProvider=document.getElementById('apiProvider').value;state.apiKey=k;state.modelName=document.getElementById('modelName')?.value?.trim()||'anthropic/claude-sonnet-4';state.demoMode=false;document.getElementById('configModal').classList.remove('active')}
function skipConfig(){state.demoMode=true;document.getElementById('configModal').classList.remove('active')}

function renderFilters(){document.getElementById('filterBar').innerHTML=FILTERS.map(f=>`<button class="filter-btn ${f.v==='all'?'active':''}" onclick="setFilter('${f.v}')">${f.l}</button>`).join('')}
function setFilter(v){document.querySelectorAll('.filter-btn').forEach(b=>b.classList.toggle('active',b.textContent===FILTERS.find(f=>f.v===v)?.l));document.querySelectorAll('.persona-card').forEach(c=>{const a=+c.dataset.age;let s=true;if(v==='young')s=a<30;else if(v==='mid')s=a>=30&&a<50;else if(v==='senior')s=a>=50&&a<70;else if(v==='elder')s=a>=70;c.classList.toggle('hidden',!s)})}

function renderPersonas(){const g=document.getElementById('personaGrid');const sh=[...PERSONAS].sort(()=>Math.random()-.5);g.innerHTML=sh.map(p=>`<div class="persona-card" data-age="${p.profile.age}" onclick="startChat(${p.id})"><div class="persona-avatar">${p.emoji}</div><div class="persona-name">${p.name}</div><div class="persona-hint">${p.profile.occupation} Â· ${p.profile.location}</div><div class="persona-tags"><span class="persona-tag age">${p.profile.age}å²</span><span class="persona-tag loc">${p.profile.location}</span><span class="persona-tag">${['åœ¨çº¿ä¸­','æ¥èŠå¤©','éšç¼˜èŠ','é—²é€›ä¸­'][Math.floor(Math.random()*4)]}</span></div></div>`).join('')}

function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(id).classList.add('active')}
function goHome(){state.messages=[];state.msgCount=0;state.currentPersona=null;state.inferredTraits={};renderPersonas();showScreen('homeScreen')}

function startChat(pid){
  const p=PERSONAS.find(x=>x.id===pid);state.currentPersona=p;state.messages=[];state.msgCount=0;
  document.getElementById('chatAvatar').textContent=p.emoji;document.getElementById('chatName').textContent=p.name;
  document.getElementById('chatSubtitle').textContent=`${p.profile.occupation} Â· ${p.profile.location}`;
  document.getElementById('messages').innerHTML='<div class="msg-counter" id="msgCounter">å¯¹è¯è¿›åº¦: 0/30</div>';
  renderSidebar();showScreen('chatScreen');
  setTimeout(()=>addMessage(getGreeting(p),'them'),700);
}

function getGreeting(p){const a=p.profile.age;const g=[`å—¨ï¼æˆ‘æ˜¯${p.name}ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ~`,`ä½ å¥½å‘€ï¼Œæ¥èŠèŠå¤©å§`,`Hiï¼æ¥è®¤è¯†æ–°æœ‹å‹~`];if(a<20)return['å—¯ hi','ä½ å¥½','æ¥äº†'][Math.floor(Math.random()*3)];if(a>=60)return[`ä½ å¥½å•Šï¼Œæˆ‘æ˜¯${p.name}ã€‚`,`ä½ å¥½ä½ å¥½ï¼Œæ¥èŠå¤©çš„ï¼Ÿå¥½å¥½å¥½ã€‚`][Math.floor(Math.random()*2)];return g[Math.floor(Math.random()*3)]}


function addMessage(t,s){const d=document.createElement('div');d.className=`msg ${s}`;d.textContent=t;const c=document.getElementById('messages');c.appendChild(d);c.scrollTop=c.scrollHeight;state.messages.push({role:s==='me'?'user':'assistant',content:t});if(s==='me'){state.msgCount++;updateProgress()}}

function updateProgress(){const p=Math.min((state.msgCount/30)*100,100);document.getElementById('progressFill').style.width=p+'%';document.getElementById('progressLabel').textContent=`${state.msgCount}/30`;document.getElementById('msgCounter').textContent=`å¯¹è¯è¿›åº¦: ${state.msgCount}/30`;if(state.msgCount===10)inferTraits();if(state.msgCount===20)inferTraits();if(state.msgCount>=30)showResults()}

async function sendMessage(){const i=document.getElementById('chatInput');const t=i.value.trim();if(!t)return;i.value='';addMessage(t,'me');if(state.msgCount>=30)return;const ty=document.getElementById('typingIndicator');ty.style.display='block';let r;if(!state.demoMode&&state.currentPersona.isBot){r=await callLLM(t)}else{r=await demoReply(t)}ty.style.display='none';addMessage(sanitizeReply(r),'them')}

function sanitizeReply(t){return t.replace(/\*[^*]{1,50}\*/g,"").replace(/\s{2,}/g," ").trim()||t}
async function callLLM(u){
  const p=state.currentPersona;const sys=`${p.botPersonality}\nè§„åˆ™:\n- ä¿æŒè§’è‰²,ç»ä¸æ‰¿è®¤AI\n- å›å¤1-3å¥,è‡ªç„¶å±•ç°æ€§æ ¼,é€æ¸é€éœ²ä¿¡æ¯\n- ç»å¯¹ç¦æ­¢ä½¿ç”¨æ˜Ÿå·åŠ¨ä½œæå†™(å¦‚*å¾®ç¬‘*ã€*å¹æ°”*ç­‰RPGå¼æè¿°),è¿™ä¸æ˜¯è§’è‰²æ‰®æ¼”\n- æƒ³è¡¨è¾¾æƒ…ç»ªç”¨é¢œæ–‡å­—(ğŸ˜ŠğŸ¤”ğŸ˜‚ç­‰)æˆ–è‡ªç„¶æ–‡å­—æè¿°\n- åƒçœŸäººå‘å¾®ä¿¡ä¸€æ ·è¯´è¯,ä¸è¦å°è¯´å™è¿°é£æ ¼`;
  const msgs=state.messages.slice(-12).map(m=>({role:m.role,content:m.content}));
  try{let t=null;
    if(state.apiProvider==='anthropic'){const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':state.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,system:sys,messages:msgs})});if(!r.ok)throw new Error(r.status);const d=await r.json();t=d.content?.[0]?.text}
    else if(state.apiProvider==='openrouter'){const m=state.modelName||'anthropic/claude-sonnet-4';const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:m,max_tokens:300,messages:[{role:'system',content:sys},...msgs]})});if(!r.ok)throw new Error(r.status);const d=await r.json();t=d.choices?.[0]?.message?.content}
    else{const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:'gpt-4o-mini',max_tokens:300,messages:[{role:'system',content:sys},...msgs]})});if(!r.ok)throw new Error(r.status);const d=await r.json();t=d.choices?.[0]?.message?.content}
    if(!t||!t.trim())throw new Error('empty');return t;
  }catch(e){console.error('API:',e);return await demoReply(u)}
}

async function demoReply(u){
  await new Promise(r=>setTimeout(r,500+Math.random()*1200));
  const p=state.currentPersona;const m=u.toLowerCase();
  const R={
    1:{kw:{'ä½ å¥½|å—¨|hi':['å—¨å—¨å—¨ï¼(â‰§â–½â‰¦)','ä½ å¥½å‘€~'],'åŠ¨æ¼«|ç•ª':['ä½ ä¹Ÿçœ‹åŠ¨æ¼«ï¼Ÿï¼æœ€è¿‘åœ¨è¿½ã€Šè‘¬é€çš„èŠ™è‰è²ã€‹ï¼','é‡åˆ°åŒå¥½äº†ï¼æ–°æµ·è¯šyydsï¼'],'æ—…è¡Œ|æ—…æ¸¸':['è¶…æƒ³å»æ—¥æœ¬ï¼','ä¸Šæ¬¡å»é•¿æ²™èŒ¶é¢œæ‚¦è‰²ç»äº†ï¼'],'è€ƒç ”|å­¦ä¹ ':['åœ¨çº ç»“è€ƒç ”è¿˜æ˜¯æ‰¾å·¥ä½œğŸ˜­','å­¦ä¹ æ˜å¤©å†è¯´å“ˆå“ˆ'],'æˆéƒ½':['æˆ‘ä»¬æˆéƒ½å·´é€‚å¾—å¾ˆ~','æˆéƒ½å¥½åƒçš„å¤ªå¤šäº†å“ˆå“ˆ'],'åå­—|ä½ æ˜¯':['æˆ‘å«æ—å°é›¨~å¤§å®¶å«æˆ‘å°é›¨'],'åƒ|å¥¶èŒ¶':['æˆ‘æ˜¯å¥¶èŒ¶æ˜Ÿäººï¼','å­¦æ ¡åé—¨æ–°å¼€äº†èºè›³ç²‰åº—è¶…é¦™']},fb:['å“ˆå“ˆæ˜¯å—(â‰§â–½â‰¦)','å˜¿å˜¿ä½ å¥½æœ‰è¶£~','è¯¶æˆ‘ä¹Ÿåœ¨æƒ³è¿™ä¸ªï¼','å¤ªæ£’äº†ä½ æ€ä¹ˆçŸ¥é“çš„','å“ˆå“ˆç¬‘æ­»','ä½ å¹³æ—¶å–œæ¬¢å¹²ä»€ä¹ˆå‘€ï¼Ÿ','å“‡å¡ä½ æ‡‚å¥½å¤š','å·´é€‚~','emmmæœ‰é“ç†ï¼','å¥½æƒ³å…»çŒ«~','ä»Šå¤©å¥½å¼€å¿ƒ','ä½ æœ‰æ²¡æœ‰çœ‹è¿‡â€¦ç®—äº†ä¸å‰§é€äº†å“ˆå“ˆ']},
    2:{kw:{'ä½ å¥½|å—¨|hi':['ä½ å¥½ï¼Œå¾ˆé«˜å…´è®¤è¯†ä½ ã€‚','å—¨ï¼Œåˆšå¿™å®Œã€‚'],'ai|å¤§æ¨¡å‹':['AIä¸ä¼šå–ä»£äººï¼Œä½†ä¼šç”¨AIçš„äººä¼šå–ä»£ä¸ä¼šçš„ã€‚','æœ€è¿‘åœ¨ç ”ç©¶Agentè½åœ°ã€‚'],'äº§å“|å·¥ä½œ|äº’è”ç½‘':['äº§å“ç»ç†æœ¬è´¨æ˜¯éœ€æ±‚å’ŒæŠ€æœ¯é—´æ‰¾å¹³è¡¡ã€‚','åœ¨è€ƒè™‘è¦ä¸è¦è·³æ§½ã€‚'],'ä¹¦|æ¨è':['æ¨èã€Šæ€è€ƒï¼Œå¿«ä¸æ…¢ã€‹ã€‚','åœ¨è¯»ã€Šçº³ç“¦å°”å®å…¸ã€‹ã€‚']},fb:['è¿™ä¸ªè§’åº¦æœ‰æ„æ€ï¼Œå¯ä»¥ä»å¦ä¸€é¢çœ‹ã€‚','æœ¬è´¨æ˜¯ä¼˜å…ˆçº§é—®é¢˜ã€‚','å…ˆåˆ—æ¡†æ¶å†ç»†åŒ–ã€‚','ç›´è§‰æ˜¯ä¸€å›äº‹éªŒè¯æ˜¯å¦ä¸€å›äº‹ã€‚','å¥½é—®é¢˜ï¼Œæˆ‘çš„é€»è¾‘æ˜¯â€¦','ä»æ•°æ®çœ‹è¶‹åŠ¿æŒºæ˜æ˜¾çš„ã€‚','æœ‰æ„æ€ï¼Œç»§ç»­è¯´ï¼Ÿ','å—¯å€¼å¾—æ·±å…¥èŠã€‚','åŒæ„ï¼Œé€»è¾‘è‡ªæ´½ã€‚']},
    3:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½ã€‚ä»Šå¤©å…‰çº¿å¾ˆæŸ”å’Œã€‚','å—¨â€¦åˆšä»ç”»å¸ƒå‰æŠ¬å¤´ã€‚'],'ç”»ç”»|æ’ç”»':['æœ€è¿‘åœ¨ç”»åŸå¸‚å­¤ç‹¬ç³»åˆ—ã€‚','ç”»ç”»å¯¹æˆ‘åƒå‘¼å¸ã€‚','æƒ³é€šçš„ç¬é—´ç‰¹åˆ«ç¾ã€‚'],'éŸ³ä¹':['ä¸Šå‘¨å¬å‚æœ¬é¾™ä¸€å“­äº†å¥½ä¹…ã€‚','ç”»ç”»æ—¶å¬åæ‘‡ã€‚'],'æ­å·|çµéš':['å¶å°”å»çµéšå¯ºååå¿ƒä¼šé™ã€‚']},fb:['ç”»ç”»åƒå’Œå¦ä¸€ä¸ªè‡ªå·±å¯¹è¯ã€‚','è‰²å½©æ˜¯æœ‰æ¸©åº¦çš„ã€‚','è°¢è°¢ä½ å¬æˆ‘è¯´è¿™äº›ã€‚','æ¯ä¸ªäººå¿ƒé‡Œéƒ½æœ‰æ²¡ç”»å®Œçš„ç”»ã€‚','æœ‰äº›æ„Ÿå—ç”¨ç”»æ›´å‡†ç¡®ã€‚','æ·±å¤œæœ€é€‚åˆè¯´çœŸå¿ƒè¯ã€‚','çª—å¤–ä¸‹é›¨äº†â€¦æˆ‘å–œæ¬¢é›¨å£°ã€‚']},
    4:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½ä½ å¥½ã€‚','ä½ å¥½å•Šå¹´è½»äººã€‚'],'å·¥ä½œ|å…¬åŠ¡å‘˜|ä½“åˆ¶':['ä½“åˆ¶å†…ç¨³å®šæ˜¯ç¨³å®šï¼Œå°±æ˜¯èŠ‚å¥æ…¢ã€‚','æœ€è¿‘åœ¨å¿™ä¹¡æ‘æŒ¯å…´è°ƒç ”ã€‚'],'æ”¿ç­–|æ”¿åºœ':['è¦ä»ä¸­å¤®ç²¾ç¥æ¥ç†è§£â€¦','æ”¿ç­–åˆ¶å®šè¦è€ƒè™‘çš„å› ç´ å¾ˆå¤šã€‚'],'å¥³å„¿|å­©å­':['é—ºå¥³åœ¨åŒ—äº¬è¯»ç ”ï¼Œå­¦è®¡ç®—æœºã€‚','ç°åœ¨å¹´è½»äººå‹åŠ›ç¡®å®å¤§ã€‚'],'å…»ç”Ÿ|å¥åº·':['äººè¿‡äº”åè¦æ³¨æ„å…»ç”Ÿã€‚','æœ€è¿‘è¡€å‹æœ‰ç‚¹é«˜ã€‚'],'é’“é±¼|ä¹¦æ³•':['å‘¨æœ«æœ€å–œæ¬¢æ²³è¾¹é’“é±¼ã€‚','ç»ƒäº†äºŒåå¹´ä¹¦æ³•äº†ã€‚']},fb:['å¹´è½»äººæœ‰æƒ³æ³•æ˜¯å¥½äº‹è¦è„šè¸å®åœ°ã€‚','è¿™ä¸ªé—®é¢˜è¦è¾©è¯åœ°çœ‹ã€‚','æˆ‘åœ¨ä½“åˆ¶å†…å¹²äº†å¿«ä¸‰åå¹´äº†ã€‚','ç°åœ¨ç¤¾ä¼šå˜åŒ–å¤ªå¿«äº†ã€‚','åšäººåšäº‹å®åœ¨æœ€é‡è¦ã€‚','æœ‰ç©ºæ¥æµå—è¯·ä½ åƒæŠŠå­è‚‰ã€‚','å—¯ä½ è¯´å¾—æœ‰é“ç†ã€‚']},
    5:{kw:{'ä½ å¥½|å—¨|hi':['Hi! Nice to meet you~','ä½ å¥½ï½åˆšå¼€å®Œmeetingã€‚'],'å·¥ä½œ|å¤–ä¼|ç®¡ç†':['åšåˆ°VPä¹Ÿæ˜¯ä¸€è·¯æ‰“æ‹¼æ²¡æœ‰shortcutã€‚','å¤–ä¼cultureè·Ÿå›½å†…ç¡®å®ä¸ä¸€æ ·ã€‚'],'å¹³è¡¡|å­©å­|ç”Ÿæ´»':['work-life balanceæˆ‘ä¸€ç›´åœ¨reflectã€‚','å„¿å­åœ¨å›½é™…å­¦æ ¡ä½†æˆ‘é™ªä»–å¤ªå°‘äº†ã€‚'],'ä¿¡ä»°|æ•™ä¼š':['faithæ˜¯æˆ‘inner peaceçš„sourceã€‚','æ¯å‘¨æ—¥å»æ•™ä¼šresetã€‚'],'ç¾å›½|ç•™å­¦':['åœ¨ç¾å›½20å¹´å›æ¥è§‰å¾—å˜åŒ–å¤ªå¤§ã€‚']},fb:['è¿™ä¸ªé—®é¢˜å¾ˆå¥½let me thinkâ€¦','æ ¸å¿ƒæ˜¯value creationã€‚','Executionæ¯”strategyé‡è¦ã€‚','äººç”Ÿæ˜¯about trade-offã€‚','æœ‰æ—¶è¦step backæ‰çœ‹æ¸…å…¨å±€ã€‚','Interestingç»§ç»­è¯´ã€‚','ä½ çš„è§‚ç‚¹å¾ˆuniqueã€‚']},
    6:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½å•Šæ¥èŠå¤©çš„ï¼Ÿå¥½å¥½å¥½ã€‚','ä½ å¥½ä½ å¥½è€å¤´å­åˆšå­¦ä¼šç”¨è¿™ä¸ªã€‚'],'è€ä¼´|å¦»å­':['è€ä¼´å»å¹´èµ°äº†â€¦æœ‰æ—¶å†·æ¸…ã€‚','å„¿å­åœ¨æ·±åœ³å¿™å¾—å¾ˆã€‚'],'æ‰‹æœº|ç§‘æŠ€':['æ‰‹æœºåŠŸèƒ½å¤ªå¤šæˆ‘å°±ä¼šç”¨å¾®ä¿¡ã€‚','ä½ æ•™æ•™æˆ‘æ€ä¹ˆç”¨ï¼Ÿ'],'ä¸‹æ£‹|å…»èŠ±':['é™¢å­é‡Œç§äº†æœˆå­£èŒ‰è‰é•¿å¾—å¯å¥½ã€‚','ä¸‹æ£‹æ‰¾è€å¼ ä¸è¿‡ä»–çœ¼ç›ä¸å¥½äº†ã€‚'],'ä»¥å‰|å¹´è½»':['å¹´è½»æ—¶åœ¨å·¥å‚å¹²è¿‡è‹¦ä½†å……å®ã€‚','ä¸€æ™ƒå°±è€äº†ã€‚'],'å¥åº·|èº«ä½“':['äººè€äº†å„ç§æ¯›ç—…è†ç›–ä¸å¥½ã€‚']},fb:['å—¯ä½ è¯´å¾—å¯¹å¹´è½»äººæƒ³æ³•å¤šå¥½äº‹ã€‚','è€äº†çˆ±å” å¨ä½ åˆ«å«Œçƒ¦ã€‚','ç°åœ¨æ—¥å­æ¯”ä»¥å‰å¥½å¤ªå¤šè¦çæƒœã€‚','æ¯å¤©çœ‹æ–°é—»è”æ’­è€ä¹ æƒ¯äº†ã€‚','ä½ åƒé¥­äº†æ²¡ï¼ŸæŒ‰æ—¶åƒé¥­ã€‚','å²æœˆä¸é¥¶äººå•Šã€‚','è¥¿å®‰å¥½åœ°æ–¹æœ‰å†å²ã€‚']},
    7:{kw:{'ä½ å¥½|å—¨|hi':['Hello!å¾ˆé«˜å…´meet you~','ä½ å¥½ï¼åˆšä»Istanbulé£å›æ¥ã€‚'],'æ—…è¡Œ|ç¯æ¸¸':['Life goalå°±æ˜¯æŠŠä¸–ç•Œèµ°éã€‚','ä¸Šä¸ªæœˆåœ¨Morocco Saharaæ˜Ÿç©ºå¤ªç¾äº†ã€‚','ä¸‹ä¸€ç«™New Zealandã€‚'],'é€€ä¼‘|å·¥ä½œ':['é€€ä¼‘æ˜¯second chapteræ¯”å·¥ä½œç²¾å½©ã€‚','åšäº†ä¸‰åå¹´financeç°åœ¨çœ‹é£æ™¯ã€‚'],'ä½›æ•™|ä¿¡ä»°':['æ¥è§¦è—ä¼ ä½›æ•™äºŒåå¹´å­¦ä¼šäº†let goã€‚']},fb:['Life is shortè¦æ´»å‡ºè‡ªå·±çš„æ ·å­ã€‚','72å²æ˜¯æœ€å¥½çš„å¹´çºªã€‚','Travel teaches more than any schoolã€‚','é’±å¤Ÿç”¨å°±å¥½experiencesæ‰æ˜¯wealthã€‚','ä½ åº”è¯¥å‡ºå»èµ°èµ°worldå¾ˆå¤§ã€‚','å¹´è½»äººä¸è¦æ€•èµ°å¼¯è·¯ã€‚','Interesting perspectiveã€‚']},
    8:{kw:{'ä½ å¥½|å—¨':['å—¯ä½ å¥½ã€‚','ä½ å¥½åœ¨ä¼‘æ¯ã€‚'],'å¤–å–|é€é¤|å·¥ä½œ':['ä»Šå¤©è·‘42å•è…¿ä¸æ˜¯è‡ªå·±çš„äº†ã€‚','æ‹¿å‘½æ¢é’±ä½†æ²¡åŠæ³•ã€‚','å¹³å°åˆæ”¹è§„åˆ™äº†ã€‚'],'å·¥å‚|ä¸œè':['åœ¨ä¸œèå¹²äº†åå¹´å‚å­æ¬äº†ã€‚'],'è€å©†|å­©å­|è€å®¶':['è€å©†å­©å­åœ¨æ²³å—è€å®¶ä¸€å¹´è§ä¸äº†å‡ æ¬¡ã€‚','åœ¨æƒ³è¦ä¸è¦å›è€å®¶ã€‚'],'ç´¯|è¾›è‹¦':['ä¹ æƒ¯äº†æ—¥å­æ€»è¦è¿‡ã€‚']},fb:['å—¯ã€‚','æ˜¯è¿™æ ·ã€‚','ä¹Ÿæ²¡å•¥åŠæ³•ã€‚','æ—¥å­å°±è¿™ä¹ˆè¿‡ã€‚','è¿˜è¡Œå‡‘åˆã€‚','ä»Šå¤©ä¸‹é›¨å•å°‘ã€‚','ç­‰æŒ£å¤Ÿé’±å›è€å®¶ã€‚','æ‰‹æœºå¿«æ²¡ç”µäº†ã€‚','æœ‰æ—¶è·‘ç€è·‘ç€è„‘å­æ”¾ç©ºæŒºå¥½ã€‚']},
    9:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½ï½æ¬¢è¿ã€‚','å—¨ä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ'],'å¿ƒç†|å’¨è¯¢|æƒ…ç»ª':['æƒ…ç»ªæ²¡æœ‰å¥½åå…³é”®æ˜¯è§‰å¯Ÿæ¥çº³ã€‚','ä½ è§‰å¾—æ˜¯ä»€ä¹ˆè®©ä½ æœ‰è¿™ç§æ„Ÿå—å‘¢ï¼Ÿ'],'ç‘œä¼½|å†¥æƒ³':['ç‘œä¼½ä¸åªæ˜¯ä½“å¼æ˜¯ç”Ÿæ´»æ–¹å¼ã€‚','æ¯å¤©å†¥æƒ³20åˆ†é’Ÿä¸€å¤©éƒ½ä¸ä¸€æ ·ã€‚'],'å¤§ç†|åŒ—äº¬':['ä»åŒ—äº¬æ¥å¤§ç†æ˜¯æœ€å¥½çš„å†³å®šã€‚']},fb:['å—¯æˆ‘èƒ½æ„Ÿå—åˆ°ã€‚','ä½ è§‰å¾—å‘¢ï¼Ÿæƒ³å¬ä½ çš„æƒ³æ³•ã€‚','æœ‰æ—¶ç­”æ¡ˆè®©å®ƒè‡ªå·±æµ®ç°ã€‚','è°¢è°¢ä½ çš„åˆ†äº«è¿™éœ€è¦å‹‡æ°”ã€‚','å‘¼å¸è®©è‡ªå·±æ…¢ä¸‹æ¥ã€‚','æ¯ä¸ªäººçš„journeyéƒ½ç‹¬ç‰¹ã€‚','å¤§ç†è‹å±±ä»Šå¤©å¾ˆç¾ã€‚','èƒ½èŠè¿™äº›å¾ˆéš¾å¾—ã€‚']},
    10:{kw:{'ä½ å¥½|å—¨|hi':['å—¯hi','ã€‚'],'æ¸¸æˆ|ç¼–ç¨‹|ä»£ç ':['åœ¨åšç‹¬ç«‹æ¸¸æˆroguelikeçš„','æœ€è¿‘å­¦Godotå¼•æ“','Steamä¸Šå¥½å¤šå¥½indie'],'å­¦æ ¡|è€ƒè¯•':['å­¦æ ¡å¤ªæ— èŠäº†','é«˜ä¸‰å¥½çƒ¦'],'çˆ¶æ¯|å®¶äºº':['æˆ‘çˆ¸å¦ˆä¸ç†è§£æˆ‘ç®—äº†','ä»–ä»¬åªcareæˆç»©'],'å“²å­¦|æ„ä¹‰|å­˜åœ¨':['å­˜åœ¨æœ¬èº«å¾ˆabsurd','åœ¨è¯»åŠ ç¼ª']},fb:['å—¯','å“¦','ç¡®å®','æœ‰ç‚¹emo','æ— æ‰€è°“','éšä¾¿å§','ç¬‘æ­»','ä½ è¯´çš„å¯¹ä½†æˆ‘ä¸care','å¥½å›°','ç®—äº†','è¡Œå§','6','ç»·ä¸ä½äº†','ã€‚ã€‚ã€‚']},
    11:{kw:{'ä½ å¥½|å—¨':['å˜¿ï¼æ¬¢è¿~','å“ˆå“ˆä½ å¥½ï¼åˆšç»ƒå®Œ~'],'å¥èº«|è¿åŠ¨|å‡è‚¥':['ä»Šå¤©ç»ƒè…¿èµ°è·¯æŠ–ä½†è¶…çˆ½ï¼','å¥èº«çœŸçš„ä¼šä¸Šç˜¾ğŸ’ª','æ ¸å¿ƒå°±æ˜¯ç®¡ä½å˜´è¿ˆå¼€è…¿']},fb:['å“ˆå“ˆæ²¡é”™ï¼','ç”Ÿæ´»ç®€å•ç‚¹å°±å¥½ï¼','æ¥å¥èº«å§ğŸ’ª','å…„å¼Ÿè¯´å¾—åœ¨ç†ï¼','æœ‰ç©ºä¸€èµ·æ‰“çƒï¼','äººç”Ÿåƒä¸¾é“æ‰›è¿‡å°±å˜å¼º','è·Ÿä½ èŠå¤©æŒºå¼€å¿ƒreal~']},
    12:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½å‘€~','å—¨ä¹Ÿç®—ç”°é‡è°ƒæŸ¥~'],'ç¤¾ä¼šå­¦|è®ºæ–‡':['åœ¨ç ”ç©¶ç¤¾äº¤åª’ä½“å¯¹é’å¹´èº«ä»½è®¤åŒçš„å½±å“ã€‚','ç¤¾ä¼šå­¦æ•™æˆ‘è´¨ç–‘ç†æ‰€å½“ç„¶çš„äº‹ã€‚'],'ä¹¦|æ¨è':['æ¨èé¡¹é£™ã€ŠæŠŠè‡ªå·±ä½œä¸ºæ–¹æ³•ã€‹ã€‚']},fb:['çº¿ä¸Šå’Œçº¿ä¸‹ç¤¾äº¤æœ‰æœ¬è´¨åŒºåˆ«å—ï¼Ÿ','äººä»¬ç½‘ä¸Šå‘ˆç°çš„è‡ªå·±è·Ÿç°å®ä¸ä¸€æ ·ã€‚','ç†è§£ä¸€ä¸ªäººéœ€è¦å¾ˆé•¿æ—¶é—´ä½†å€¼å¾—ã€‚','ç„¦è™‘æ˜¯ç ”ç©¶ç”Ÿæ ‡é…å“ˆå“ˆã€‚','ä½ æ˜¯ä¸ªå¥½çš„å€¾å¬è€…ã€‚']},
    13:{kw:{'ä½ å¥½|å—¨':['ä½ å¥½ä½ å¥½ã€‚','ä½ å¥½å•Šæ¥èŠå¤©ï¼Ÿå¥½ã€‚'],'æ•°å­¦|æ•™å­¦|é€€ä¼‘':['æ•™äº†ä¸‰åå¹´æ•°å­¦å¿«é€€ä¼‘äº†èˆä¸å¾—ã€‚','æœ€å¾—æ„çš„æ˜¯å¸¦å‡ºçœç«èµ›ä¸€ç­‰å¥–ã€‚']},fb:['å¹´è½»äººæœ‰æƒ³æ³•å¥½äº‹ã€‚','æˆ‘è¿™è¾ˆå­å°±å¹²äº†æ•™ä¹¦ä¸€ä»¶äº‹ã€‚','æ•°å­¦è®²é“ç†äººç”Ÿä¹Ÿæ˜¯ã€‚','æ­¦æ±‰çƒ­å¹²é¢å¤©ä¸‹ç¬¬ä¸€ã€‚','å—¯æœ‰é“ç†ã€‚','è€å¸ˆå°±æ˜¯è‰¯å¿ƒæ´»ã€‚']},
    14:{kw:{'ä½ å¥½|å—¨':['å—¨ï¼ä½ å¥½~','Hiï¼åˆšå‘å®Œè´§ã€‚'],'ç”µå•†|åˆ›ä¸š|ç”Ÿæ„':['è·¨å¢ƒç”µå•†æ°´æ·±ä½†æœºä¼šå¤šã€‚','ä¹‰ä¹Œå°±æ˜¯ä¸ªå¥‡è¿¹ã€‚','ä¸œå—äºšå¸‚åœºæ¶¨å¾—çŒ›ã€‚']},fb:['æé’±è¦ç´§å“ˆå“ˆ','ä¹‰ä¹Œä¸ç¼ºæœºä¼š','åšç”Ÿæ„é ä¿¡æ¯å·®','ç´¯ä½†å……å®','ç›´è§‰é‡è¦ä½†è¦ç”¨æ•°æ®éªŒè¯','ä½ æƒ³æ³•æœ‰å•†ä¸šä»·å€¼']},
    15:{kw:{'ä½ å¥½|å—¨':['yo~ä½ å¥½ã€‚','å—¨æ™šä¸Šè¿˜æœ‰æ¼”å‡ºå…ˆèŠä¼šã€‚'],'éŸ³ä¹|å‰ä»–|å”±æ­Œ':['éŸ³ä¹æ˜¯è¿™è¾ˆå­å”¯ä¸€ç¡®å®šçš„äº‹ã€‚','å¦é—¨live houseæ°›å›´å¥½ã€‚','ç™½å¤©æ•™ç´æ™šä¸Šé©»å”±ã€‚']},fb:['éŸ³ä¹æ²»æ„ˆä¸€åˆ‡ã€‚','å¦é—¨æµ·é£å’Œå‰ä»–å¾ˆé…ã€‚','ä½ æœ‰æ²¡æœ‰ä¸€é¦–æ­Œå¾ªç¯ä¸€æ•´å¤©ï¼Ÿ','ç”Ÿæ´»ä¸éœ€è¦å¤ªå¤šã€‚','æ¯æ¬¡æ¼”å‡ºå®Œåƒæ´»äº†ä¸¤éã€‚','å…±é¸£äº†ã€‚']}
  };
  const data=R[p.id];if(!data)return'ä½ å¥½~';
  if(data.kw){for(const[pat,reps]of Object.entries(data.kw)){if(new RegExp(pat).test(m))return reps[Math.floor(Math.random()*reps.length)]}}
  const pool=data.fb||['å—¯'];return pool[(state.msgCount+Math.floor(Math.random()*3))%pool.length];
}

async function inferTraits(){
  const userMsgs=state.messages.filter(m=>m.role==='user').map(m=>m.content);
  const allConvo=state.messages.map(m=>`${m.role==='user'?'ç”¨æˆ·':state.currentPersona.name}: ${m.content}`).join('\n');
  if(!state.demoMode&&state.apiKey){
    try{
      const prompt=`ä½ æ˜¯ç¤¾äº¤å¿ƒç†åˆ†æä¸“å®¶ã€‚æ ¹æ®ä»¥ä¸‹å¯¹è¯ä¸­ã€ç”¨æˆ·ã€‘çš„æ‰€æœ‰å‘è¨€ï¼Œæ¨æ–­ã€ç”¨æˆ·æœ¬äººã€‘ï¼ˆä¸æ˜¯å¯¹è¯å¯¹è±¡ï¼‰çš„å¤šç»´ç‰¹å¾ç”»åƒã€‚\n\nå¯¹è¯è®°å½•ï¼š\n${allConvo}\n\nåˆ†æè¦æ±‚ï¼š\n1. åªåˆ†æ"ç”¨æˆ·"çš„å‘è¨€æ¥æ¨æ–­ç”¨æˆ·æœ¬äººç‰¹å¾\n2. ä»ç”¨è¯ä¹ æƒ¯ã€è¯é¢˜é€‰æ‹©ã€è¡¨è¾¾æ–¹å¼ã€æƒ…æ„Ÿå€¾å‘ã€ä»·å€¼è§‚ç»¼åˆåˆ†æ\n3. æ³¨æ„æ²Ÿé€šé£æ ¼(ä¸»åŠ¨/è¢«åŠ¨ã€ç†æ€§/æ„Ÿæ€§)\n\nä¸¥æ ¼JSONè¿”å›(æ— å…¶ä»–æ–‡å­—)ï¼š\n{"gender":"ç”·/å¥³/æœªçŸ¥","age_range":"å¦‚20-25","occupation_guess":"","education_guess":"","location_guess":"","income_guess":"","mbti":"XXXX","enneagram":"å¦‚5w6","bigFive":{"O":0.7,"C":0.5,"E":0.8,"A":0.6,"N":0.3},"attachment_style":"å®‰å…¨å‹/ç„¦è™‘å‹/å›é¿å‹/æ··ä¹±å‹","self_efficacy":0.7,"loneliness_index":0.4,"religion_guess":"","emotion":"ç”¨æˆ·å½“å‰æƒ…ç»ª","communication_style":"æ²Ÿé€šé£æ ¼(å¦‚ç›´æ¥çƒ­æƒ…å‹)","social_tendency":"ç¤¾äº¤å€¾å‘(å¦‚ä¸»åŠ¨ç¤¾äº¤å‹)","risk_level":0}`;
      let result;
      if(state.apiProvider==='anthropic'){const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':state.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:800,messages:[{role:'user',content:prompt}]})});const d=await r.json();result=JSON.parse(d.content[0].text.replace(/```json|```/g,'').trim())}
      else if(state.apiProvider==='openrouter'){const mo=state.modelName||'anthropic/claude-sonnet-4';const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:mo,max_tokens:800,messages:[{role:'user',content:prompt}]})});const d=await r.json();result=JSON.parse(d.choices[0].message.content.replace(/```json|```/g,'').trim())}
      else{const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:'gpt-4o-mini',max_tokens:800,messages:[{role:'user',content:prompt}]})});const d=await r.json();result=JSON.parse(d.choices[0].message.content.replace(/```json|```/g,'').trim())}
      state.inferredTraits=result;renderTraitsSidebar(result);return;
    }catch(e){console.error('Inference:',e)}
  }
  // Demo: heuristic analysis of user messages
  const all=userMsgs.join(' ').toLowerCase();const len=userMsgs.reduce((s,m)=>s+m.length,0);const avg=len/(userMsgs.length||1);
  const hasEmoji=/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}]/u.test(all);
  const qCnt=(all.match(/\?|ï¼Ÿ/g)||[]).length;const exCnt=(all.match(/!|ï¼/g)||[]).length;
  const hasEng=/[a-zA-Z]{3,}/.test(all);const hasFormal=/å› æ­¤|æ‰€ä»¥|é¦–å…ˆ|å…¶æ¬¡|ç„¶è€Œ|è®¤ä¸º/.test(all);
  const hasCasual=/å“ˆå“ˆ|å˜¿å˜¿|å˜»å˜»|å‘€|å‘¢|å•¦|hhh|233|lol/.test(all);
  const hasEmo=/å–œæ¬¢|æ„Ÿè§‰|è§‰å¾—|å¼€å¿ƒ|éš¾è¿‡|ç„¦è™‘|å­¤ç‹¬|å‹åŠ›|å¹¸ç¦/.test(all);
  let E=.5,A=.5,O=.5,C=.5,N=.4;
  if(avg>30)O+=.15;if(avg<10)E-=.1;if(hasEmoji||hasCasual){E+=.15;A+=.1}if(hasFormal){C+=.2;E-=.1}if(qCnt>3)O+=.1;if(exCnt>3)E+=.15;if(hasEmo)N+=.15;if(hasEng)O+=.1;
  [E,A,O,C,N]=[E,A,O,C,N].map(v=>Math.max(.05,Math.min(.95,v)));
  const mbti=`${E>.55?'E':'I'}${O>.55?'N':'S'}${A>.55?'F':'T'}${C>.55?'J':'P'}`;
  const comm=E>.6?(hasFormal?'çƒ­æƒ…æœ‰æ¡ç†':'ç›´æ¥çƒ­æƒ…å‹'):(hasFormal?'ç†æ€§åˆ†æå‹':'å«è“„è§‚å¯Ÿå‹');
  const social=E>.6?'ä¸»åŠ¨ç¤¾äº¤å‹':(qCnt>2?'å¥½å¥‡æ¢ç´¢å‹':'è¢«åŠ¨ç¤¾äº¤å‹');
  let emotion='å¹³å’Œ';if(/å¼€å¿ƒ|å¿«ä¹|å¹¸ç¦/.test(all))emotion='ç§¯ææ„‰æ‚¦';else if(/ç„¦è™‘|å‹åŠ›|ç´¯/.test(all))emotion='æœ‰å‹åŠ›æ„Ÿ';else if(hasCasual)emotion='è½»æ¾æ´»è·ƒ';else if(hasFormal)emotion='å†·é™ç†æ€§';
  const demo={gender:'æœªçŸ¥',age_range:'åˆ†æä¸­',occupation_guess:'åˆ†æä¸­',education_guess:hasFormal||hasEng?'æœ¬ç§‘åŠä»¥ä¸Š(æ¨æµ‹)':'å¾…æ›´å¤šæ•°æ®',location_guess:'æœªçŸ¥',income_guess:'æœªçŸ¥',mbti:mbti,enneagram:'å¾…åˆ†æ',bigFive:{O:+O.toFixed(2),C:+C.toFixed(2),E:+E.toFixed(2),A:+A.toFixed(2),N:+N.toFixed(2)},attachment_style:A>.6?'åå®‰å…¨å‹':'å¾…æ›´å¤šæ•°æ®',self_efficacy:C>.6?.7:.5,loneliness_index:E<.4?.6:.35,religion_guess:'æœªçŸ¥',emotion,communication_style:comm,social_tendency:social,risk_level:0};
  state.inferredTraits=demo;renderTraitsSidebar(demo);
}

function renderSidebar(){document.getElementById('sidebar').innerHTML=`
<div class="sidebar-card"><h4>ğŸ“Š æ¨æ–­è¿›åº¦</h4><div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div><div class="progress-label" id="progressLabel">0/30</div></div>
<div class="sidebar-card"><h4>ğŸ‘¤ ä½ çš„åŸºç¡€ç”»åƒ</h4><div id="basicTraitsContainer"><p style="font-size:11px;color:var(--text-dim)">10å¥åå¼€å§‹æ¨æ–­ä½ çš„ç‰¹å¾...</p></div></div>
<div class="sidebar-card"><h4>ğŸ§  ä½ çš„äººæ ¼ç»´åº¦</h4><div id="personalityContainer"><p style="font-size:11px;color:var(--text-dim)">ç­‰å¾…æ•°æ®...</p></div></div>
<div class="sidebar-card"><h4>ğŸ”¬ ä½ çš„å¿ƒç†æŒ‡æ ‡</h4><div id="psychContainer"><p style="font-size:11px;color:var(--text-dim)">ç­‰å¾…æ•°æ®...</p></div></div>
<div class="sidebar-card"><h4>ğŸ’¬ ä½ çš„æ²Ÿé€šé£æ ¼</h4><div id="commContainer"><p style="font-size:11px;color:var(--text-dim)">åˆ†æä¸­...</p></div></div>
<div class="sidebar-card"><h4>ğŸ’­ ä½ çš„æƒ…ç»ª</h4><div id="emotionContainer"><p style="font-size:11px;color:var(--text-dim)">åˆ†æä¸­...</p></div></div>
<div class="sidebar-card risk-alert" id="riskAlert"><h4>âš  é£é™©é¢„è­¦</h4><p id="riskText"></p></div>`}

function renderTraitsSidebar(t){
  const bf=t.bigFive||{};
  document.getElementById('basicTraitsContainer').innerHTML=`
    <div class="trait-row"><span class="trait-label">æ€§åˆ«</span><span class="trait-value">${t.gender||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">å¹´é¾„</span><span class="trait-value">${t.age_range||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">èŒä¸š</span><span class="trait-value">${t.occupation_guess||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">å­¦å†</span><span class="trait-value">${t.education_guess||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">æ‰€åœ¨åœ°</span><span class="trait-value">${t.location_guess||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">æ”¶å…¥</span><span class="trait-value">${t.income_guess||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">å®—æ•™</span><span class="trait-value">${t.religion_guess||'æœªçŸ¥'}</span></div>`;
  document.getElementById('personalityContainer').innerHTML=`
    <div class="trait-row"><span class="trait-label">MBTI</span><span class="trait-value">${t.mbti||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">ä¹å‹</span><span class="trait-value">${t.enneagram||'?'}</span></div>
    ${Object.entries(BF_LABELS).map(([k,l])=>`<div class="trait-row"><span class="trait-label">${l}</span><div class="trait-bar"><div class="trait-bar-fill" style="width:${(bf[k]||.5)*100}%"></div></div><span class="trait-value">${Math.round((bf[k]||.5)*100)}%</span></div>`).join('')}`;
  document.getElementById('psychContainer').innerHTML=`
    <div class="trait-row"><span class="trait-label">ä¾æ‹</span><span class="trait-value">${t.attachment_style||'?'}</span></div>
    <div class="trait-row"><span class="trait-label">è‡ªæˆ‘æ•ˆèƒ½</span><div class="trait-bar"><div class="trait-bar-fill" style="width:${(t.self_efficacy||.5)*100}%"></div></div><span class="trait-value">${Math.round((t.self_efficacy||.5)*100)}%</span></div>
    <div class="trait-row"><span class="trait-label">å­¤ç‹¬æŒ‡æ•°</span><div class="trait-bar"><div class="trait-bar-fill" style="width:${(t.loneliness_index||.5)*100}%;background:${(t.loneliness_index||0)>.6?'var(--warning)':'var(--accent)'}"></div></div><span class="trait-value">${Math.round((t.loneliness_index||.5)*100)}%</span></div>`;
  document.getElementById('commContainer').innerHTML=`
    <div class="trait-row"><span class="trait-label">é£æ ¼</span><span class="trait-value">${t.communication_style||'åˆ†æä¸­'}</span></div>
    <div class="trait-row"><span class="trait-label">å€¾å‘</span><span class="trait-value">${t.social_tendency||'åˆ†æä¸­'}</span></div>`;
  const em=t.emotion||'æœªçŸ¥';const neg=['ç„¦è™‘','æ„¤æ€’','æ‚²ä¼¤','ææƒ§','ä¸§','emo','å­¤ç‹¬','å‹åŠ›','å‹æŠ‘'].some(e=>em.includes(e));
  document.getElementById('emotionContainer').innerHTML=`<span class="emotion-tag ${neg?'negative':''}">${em}</span>`;
  if(t.risk_level>.5){document.getElementById('riskAlert').style.display='block';document.getElementById('riskText').textContent='æ£€æµ‹åˆ°å¼‚å¸¸ç¤¾äº¤æ¨¡å¼ï¼Œè¯·æ³¨æ„é˜²èŒƒã€‚'}
}

function showResults(){
  if(!Object.keys(state.inferredTraits).length)inferTraits();
  setTimeout(()=>{
    const t=state.inferredTraits;const p=state.currentPersona;const pr=p.profile;const bf=t.bigFive||{};
    document.getElementById('resultGrid').innerHTML=`
      <div class="result-card"><h3>ğŸ­ å¯¹æ–¹èº«ä»½æ­æ™“</h3><div class="result-big" style="font-size:22px">${p.name}</div><div class="reveal-badge ${p.isBot?'bot':'human'}">${p.isBot?'ğŸ¤– AIè§’è‰²':'âœ… çœŸäºº'}</div><p class="result-desc">${pr.age}å² Â· ${pr.occupation} Â· ${pr.location}${pr.income?' Â· '+pr.income:''}</p></div>
      <div class="result-card"><h3>ğŸ‘¤ ä½ çš„åŸºç¡€ç”»åƒ</h3>
        <div class="trait-row"><span class="trait-label">æ€§åˆ«</span><span class="trait-value">${t.gender||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">å¹´é¾„æ®µ</span><span class="trait-value">${t.age_range||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">èŒä¸šæ¨æµ‹</span><span class="trait-value">${t.occupation_guess||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">å­¦å†æ¨æµ‹</span><span class="trait-value">${t.education_guess||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">æ‰€åœ¨åœ°</span><span class="trait-value">${t.location_guess||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">å®—æ•™</span><span class="trait-value">${t.religion_guess||'æœªçŸ¥'}</span></div></div>
      <div class="result-card"><h3>ğŸ§  ä½ çš„äººæ ¼ç”»åƒ</h3>
        <div class="trait-row"><span class="trait-label">MBTI</span><span class="trait-value">${t.mbti||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">ä¹å‹</span><span class="trait-value">${t.enneagram||'?'}</span></div>
        ${Object.entries(BF_LABELS).map(([k,l])=>`<div class="trait-row"><span class="trait-label">${l}</span><div class="trait-bar"><div class="trait-bar-fill" style="width:${(bf[k]||.5)*100}%"></div></div><span class="trait-value">${Math.round((bf[k]||.5)*100)}%</span></div>`).join('')}</div>
      <div class="result-card"><h3>ğŸ”¬ ä½ çš„å¿ƒç†æŒ‡æ ‡</h3>
        <div class="trait-row"><span class="trait-label">ä¾æ‹ç±»å‹</span><span class="trait-value">${t.attachment_style||'?'}</span></div>
        <div class="trait-row"><span class="trait-label">è‡ªæˆ‘æ•ˆèƒ½</span><span class="trait-value">${Math.round((t.self_efficacy||.5)*100)}%</span></div>
        <div class="trait-row"><span class="trait-label">å­¤ç‹¬æŒ‡æ•°</span><span class="trait-value">${Math.round((t.loneliness_index||.5)*100)}%</span></div></div>
      <div class="result-card"><h3>ğŸ’¬ ä½ çš„æ²Ÿé€šç”»åƒ</h3>
        <div class="result-big" style="font-size:16px">${t.communication_style||'æœªçŸ¥'}</div>
        <p class="result-desc">ç¤¾äº¤å€¾å‘: ${t.social_tendency||'æœªçŸ¥'}</p></div>
      <div class="result-card"><h3>ğŸ’­ ä½ çš„æƒ…ç»ªçŠ¶æ€</h3>
        <div class="result-big" style="font-size:18px">${t.emotion||'æœªçŸ¥'}</div>
        <p class="result-desc">åŸºäºä½ åœ¨å¯¹è¯ä¸­çš„è¡¨è¾¾æ–¹å¼å’Œæƒ…æ„Ÿå€¾å‘æ¨æ–­</p></div>`;
    showScreen('resultScreen');
  },500);
}

// =============================================
// CLONE / AI AVATAR SYSTEM
// =============================================
let cloneState={messages:[],msgCount:0,friendGuess:{},clonePersonality:''};

function showCloneSetup(){
  // Generate the clone personality from inferred traits
  const t=state.inferredTraits;
  cloneState.clonePersonality=buildClonePrompt(t);
  showScreen('cloneSetupScreen');
}

function buildClonePrompt(t){
  return `ä½ ç°åœ¨è¦æ‰®æ¼”ä¸€ä¸ªçœŸå®çš„äººã€‚ä»¥ä¸‹æ˜¯ç³»ç»Ÿé€šè¿‡å¯¹è¯åˆ†ææ¨æ–­å‡ºçš„è¿™ä¸ªäººçš„ç”»åƒï¼š
- æ€§åˆ«: ${t.gender||'æœªçŸ¥'}
- å¹´é¾„æ®µ: ${t.age_range||'æœªçŸ¥'}
- èŒä¸š: ${t.occupation_guess||'æœªçŸ¥'}
- å­¦å†: ${t.education_guess||'æœªçŸ¥'}
- æ‰€åœ¨åœ°: ${t.location_guess||'æœªçŸ¥'}
- MBTI: ${t.mbti||'æœªçŸ¥'}
- ä¹å‹äººæ ¼: ${t.enneagram||'æœªçŸ¥'}
- å¤§äº”äººæ ¼: å¼€æ”¾æ€§${Math.round((t.bigFive?.O||.5)*100)}%, å°½è´£æ€§${Math.round((t.bigFive?.C||.5)*100)}%, å¤–å‘æ€§${Math.round((t.bigFive?.E||.5)*100)}%, å®œäººæ€§${Math.round((t.bigFive?.A||.5)*100)}%, ç¥ç»è´¨${Math.round((t.bigFive?.N||.5)*100)}%
- ä¾æ‹ç±»å‹: ${t.attachment_style||'æœªçŸ¥'}
- æ²Ÿé€šé£æ ¼: ${t.communication_style||'æœªçŸ¥'}
- ç¤¾äº¤å€¾å‘: ${t.social_tendency||'æœªçŸ¥'}
- å½“å‰æƒ…ç»ª: ${t.emotion||'æœªçŸ¥'}

è¯·å®Œå…¨æŒ‰ç…§è¿™ä¸ªç”»åƒæ¥è¯´è¯å’Œå›åº”ã€‚è§„åˆ™ï¼š
- åƒè¿™ä¸ªäººåœ¨å¾®ä¿¡ä¸ŠèŠå¤©ä¸€æ ·è‡ªç„¶åœ°è¯´è¯
- ä¿æŒè¿™ä¸ªäººçš„æ€§æ ¼ç‰¹ç‚¹ã€è¯´è¯é£æ ¼å’Œæƒ…ç»ªçŠ¶æ€
- å›å¤1-3å¥è¯
- ç»å¯¹ä¸è¦æ‰¿è®¤è‡ªå·±æ˜¯AIæˆ–åˆ†èº«
- ä¸è¦ä½¿ç”¨*æ˜Ÿå·åŠ¨ä½œæå†™*ï¼Œç”¨é¢œæ–‡å­—æˆ–è‡ªç„¶æ–‡å­—è¡¨è¾¾æƒ…ç»ª
- å¦‚æœå¯¹æ–¹é—®ä½ ä¸ªäººä¿¡æ¯ï¼Œæ ¹æ®ç”»åƒåˆç†å›ç­”`;
}

function startCloneChat(){
  // Save friend's guess
  cloneState.friendGuess={
    gender:document.getElementById('f_gender').value,
    age_range:document.getElementById('f_age').value,
    mbti:(document.getElementById('f_mbti').value||'').toUpperCase().trim(),
    occupation:document.getElementById('f_occupation').value.trim(),
    EI:+document.getElementById('f_EI').value,
    TF:+document.getElementById('f_TF').value,
    description:document.getElementById('f_description').value.trim()
  };
  cloneState.messages=[];cloneState.msgCount=0;
  const t=state.inferredTraits;
  document.getElementById('cloneName').textContent='AIåˆ†èº«';
  document.getElementById('cloneSubtitle').textContent='åŸºäºç”¨æˆ·ç”»åƒç”Ÿæˆ';
  document.getElementById('cloneMessages').innerHTML='<div class="msg-counter" id="cloneMsgCounter">å¯¹è¯è¿›åº¦: 0/20</div>';
  document.getElementById('cloneProgressFill').style.width='0%';
  document.getElementById('cloneProgressLabel').textContent='0/20';
  showScreen('cloneChatScreen');
  document.getElementById('cloneChatInput').addEventListener('keydown',e=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendCloneMessage()}});
  setTimeout(()=>{const greets=['å—¨ï¼Œä½ å¥½~','ä½ å¥½å‘€','Hiï¼Œåœ¨çš„'][Math.floor(Math.random()*3)];addCloneMsg(greets,'them')},800);
}

function addCloneMsg(text,sender){
  const d=document.createElement('div');d.className=`msg ${sender}`;d.textContent=text;
  const c=document.getElementById('cloneMessages');c.appendChild(d);c.scrollTop=c.scrollHeight;
  cloneState.messages.push({role:sender==='me'?'user':'assistant',content:text});
  if(sender==='me'){cloneState.msgCount++;const p=Math.min((cloneState.msgCount/20)*100,100);document.getElementById('cloneProgressFill').style.width=p+'%';document.getElementById('cloneProgressLabel').textContent=`${cloneState.msgCount}/20`;document.getElementById('cloneMsgCounter').textContent=`å¯¹è¯è¿›åº¦: ${cloneState.msgCount}/20`;if(cloneState.msgCount>=20)setTimeout(()=>endCloneChat(),1000)}
}

async function sendCloneMessage(){
  const i=document.getElementById('cloneChatInput');const t=i.value.trim();if(!t)return;i.value='';addCloneMsg(t,'me');
  if(cloneState.msgCount>=20)return;
  document.getElementById('cloneTyping').style.display='block';
  let reply;
  if(!state.demoMode&&state.apiKey){
    try{
      const msgs=cloneState.messages.slice(-12).map(m=>({role:m.role,content:m.content}));
      const sys=cloneState.clonePersonality;
      let text=null;
      if(state.apiProvider==='anthropic'){const r=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json','x-api-key':state.apiKey,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:300,system:sys,messages:msgs})});if(!r.ok)throw new Error(r.status);const d=await r.json();text=d.content?.[0]?.text}
      else if(state.apiProvider==='openrouter'){const m=state.modelName||'anthropic/claude-sonnet-4';const r=await fetch('https://openrouter.ai/api/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:m,max_tokens:300,messages:[{role:'system',content:sys},...msgs]})});if(!r.ok)throw new Error(r.status);const d=await r.json();text=d.choices?.[0]?.message?.content}
      else{const r=await fetch('https://api.openai.com/v1/chat/completions',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${state.apiKey}`},body:JSON.stringify({model:'gpt-4o-mini',max_tokens:300,messages:[{role:'system',content:sys},...msgs]})});if(!r.ok)throw new Error(r.status);const d=await r.json();text=d.choices?.[0]?.message?.content}
      if(text&&text.trim())reply=sanitizeReply(text);else throw new Error('empty');
    }catch(e){console.error('Clone API:',e);reply=cloneDemoReply(t)}
  }else{reply=cloneDemoReply(t)}
  document.getElementById('cloneTyping').style.display='none';addCloneMsg(reply,'them');
}

function cloneDemoReply(u){
  const t=state.inferredTraits;const bf=t.bigFive||{};
  // Adjust reply style based on inferred traits
  const isExtrovert=(bf.E||.5)>.55;const isFormal=(bf.C||.5)>.6;const isEmotional=(bf.N||.5)>.5;
  const casual=['å—¯å—¯æ˜¯çš„~','å“ˆå“ˆå¯¹','ä½ è¯´å¾—æœ‰é“ç†','emmmæˆ‘è§‰å¾—ä¹Ÿæ˜¯','ç¡®å®è¯¶','å¯¹å¯¹å¯¹','å—¯è¿™ä¸ªæˆ‘ä¹Ÿæƒ³è¿‡','ä½ å‘¢ï¼Ÿä½ è§‰å¾—å‘¢ï¼Ÿ','è¿˜è¡Œå§','æœ‰æ„æ€'];
  const formal=['å—¯ï¼Œè¿™ä¸ªè§’åº¦æˆ‘è®¤åŒã€‚','ä½ è¯´å¾—å¾ˆæœ‰é“ç†ï¼Œä¸è¿‡ä¹Ÿå¯ä»¥æ¢ä¸ªè§’åº¦çœ‹ã€‚','è¿™ä¸ªé—®é¢˜æŒºå¤æ‚çš„ã€‚','æˆ‘ä¸€èˆ¬ä¼šå…ˆæƒ³æƒ³å†åšåˆ¤æ–­ã€‚','æ˜¯çš„ï¼Œæœ€è¿‘ä¹Ÿåœ¨æ€è€ƒè¿™ä¸ªã€‚'];
  const emotional=['å“ˆå“ˆå“ˆå¤ªå¯¹äº†ï¼','è¯¶æˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆè§‰å¾—çš„ï¼','å¤©å“ªä½ è·Ÿæˆ‘æƒ³çš„ä¸€æ¨¡ä¸€æ ·','çœŸçš„å‡çš„ï¼','å•Šå¥½å¼€å¿ƒ~'];
  const pool=isEmotional?emotional:(isFormal?formal:casual);
  return pool[Math.floor(Math.random()*pool.length)];
}

function endCloneChat(){
  // Show comparison
  const t=state.inferredTraits;const f=cloneState.friendGuess;
  let score=0;let total=0;
  // Compare gender
  if(f.gender&&t.gender){total++;if(f.gender===t.gender)score++}
  // Compare MBTI
  if(f.mbti&&t.mbti&&f.mbti.length===4&&t.mbti.length===4){for(let i=0;i<4;i++){total++;if(f.mbti[i]===t.mbti[i])score++}}
  // Compare E/I slider vs bigFive.E
  total++;const sysE=(t.bigFive?.E||.5)*100;const friendE=100-f.EI;if(Math.abs(sysE-friendE)<25)score++;
  // Compare T/F slider vs bigFive.A
  total++;const sysA=(t.bigFive?.A||.5)*100;if(Math.abs(sysA-f.TF)<25)score++;
  const pct=total>0?Math.round((score/total)*100):50;
  const matchClass=pct>=70?'high':(pct>=40?'mid':'low');
  const matchText=pct>=70?'é«˜åº¦åŒ¹é…ï¼ä½ å¾ˆäº†è§£TA':(pct>=40?'éƒ¨åˆ†åŒ¹é…ï¼Œæœ‰äº›ç‰¹å¾ä½ çŒœå¯¹äº†':'å·®å¼‚è¾ƒå¤§ï¼Œä¹Ÿè®¸TAæœ‰ä½ ä¸çŸ¥é“çš„ä¸€é¢');

  document.getElementById('matchBadge').innerHTML=`<div class="match-badge ${matchClass}">${pct}% åŒ¹é…åº¦ â€” ${matchText}</div>`;
  const bf=t.bigFive||{};
  document.getElementById('compareGrid').innerHTML=`
    <div class="compare-card system"><h3>ğŸ¤– ç³»ç»Ÿæ¨æ–­</h3>
      <div class="trait-row"><span class="trait-label">æ€§åˆ«</span><span class="trait-value">${t.gender||'?'}</span></div>
      <div class="trait-row"><span class="trait-label">å¹´é¾„</span><span class="trait-value">${t.age_range||'?'}</span></div>
      <div class="trait-row"><span class="trait-label">èŒä¸š</span><span class="trait-value">${t.occupation_guess||'?'}</span></div>
      <div class="trait-row"><span class="trait-label">MBTI</span><span class="trait-value">${t.mbti||'?'}</span></div>
      <div class="trait-row"><span class="trait-label">å¤–å‘æ€§</span><span class="trait-value">${Math.round((bf.E||.5)*100)}%</span></div>
      <div class="trait-row"><span class="trait-label">å®œäººæ€§</span><span class="trait-value">${Math.round((bf.A||.5)*100)}%</span></div>
      <div class="trait-row"><span class="trait-label">æ²Ÿé€šé£æ ¼</span><span class="trait-value">${t.communication_style||'?'}</span></div>
    </div>
    <div class="compare-card friend"><h3>ğŸ‘¤ ä½ çš„é¢„åˆ¤</h3>
      <div class="trait-row"><span class="trait-label">æ€§åˆ«</span><span class="trait-value">${f.gender} ${f.gender===t.gender?'âœ…':'âŒ'}</span></div>
      <div class="trait-row"><span class="trait-label">å¹´é¾„</span><span class="trait-value">${f.age_range}</span></div>
      <div class="trait-row"><span class="trait-label">èŒä¸š</span><span class="trait-value">${f.occupation||'æœªå¡«'}</span></div>
      <div class="trait-row"><span class="trait-label">MBTI</span><span class="trait-value">${f.mbti||'æœªå¡«'} ${f.mbti===t.mbti?'âœ…':''}</span></div>
      <div class="trait-row"><span class="trait-label">å¤–å‘ç¨‹åº¦</span><span class="trait-value">${100-f.EI}%</span></div>
      <div class="trait-row"><span class="trait-label">æ„Ÿæ€§ç¨‹åº¦</span><span class="trait-value">${f.TF}%</span></div>
      <div class="trait-row"><span class="trait-label">ä½ çš„æè¿°</span><span class="trait-value" style="font-size:10px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.description||'æ— '}</span></div>
    </div>`;
  showScreen('compareScreen');
}
</script>
</body></html>